import{_ as Te,E as r,k as Ve,a as Ee,f as Se,a7 as Le,d as Ae,b as De,e as Me}from"./index-D7mwCrnB.js";import{v as Ue}from"./el-loading-B11eFGmQ.js";import{E as Ie}from"./el-progress-CH5jXrIz.js";import{r as v,c as ne,A as re,z as Re,C as Pe,q as V,s as E,N as c,S as o,Q as i,u as P,aH as ie,O as ue,M as de,aM as ce,X as H,a1 as qe,ah as S,bL as Ne,at as We,L as fe,co as ze,U as ve,br as He}from"./vue-vendor-BgjGt3mC.js";import{a as C}from"./axios-xsH4HHeE.js";import{T as Be}from"./TemplateForm-bvdl5Bxu.js";import"./lodash-BmZg10rb.js";import"./jszip-C7-yN4-L.js";import"./remark-CBsncvHK.js";import"./quill-BeGMbSWh.js";import"./el-row-DC3WJ2P2.js";import"./el-col-DzdZIOaC.js";import"./el-color-picker-GWbJeV9b.js";import"./position-CrPvG4RE.js";import"./el-switch-CB3Ssdml.js";import"./el-divider-BFeg4wsn.js";const Oe={class:"template-library-container"},je={class:"resource-layout"},Ye={class:"left-panel"},Ke={class:"my-tags-header"},Je={class:"my-tags-list"},Xe=["onClick"],Qe={class:"tag-name"},Ge={class:"right-panel"},Ze={class:"top-controls"},et={class:"action-buttons"},tt={class:"keyword-search"},at={class:"materials-display"},lt={class:"template-grid"},st=["onClick"],ot=["src"],nt={class:"template-actions"},rt={class:"template-info"},it={class:"template-name"},ut={key:0,class:"empty-state"},dt={class:"dialog-footer"},ct={class:"dialog-footer"},ft={key:0,class:"selected-font-file"},vt={class:"dialog-footer"},x="/api/ai",mt={__name:"TemplateLibrary",setup(pt){const L=v(!1),w=v("all"),b=v(""),B=v(!1),p=v(null),U=v(!1);v(!1);const I=v(!1),q=v(null),D=v(!1),N=v(!1),O=v(null),M=v({name:""}),h=v([{label:"正在加载字体列表...",value:""}]),g=v([{label:"京东模板",value:"jd"},{label:"百度模板",value:"baidu"},{label:"小说模板",value:"novel"},{label:"夸克模板",value:"quark"}]),y=v([]),X=ne(()=>y.value.length===0?[]:y.value.filter(e=>{var l;let t=!1;if(w.value==="all")t=!0;else{const n=(l=g.value.find(d=>d.value===w.value))==null?void 0:l.label;t=e.tag===n}if(!b.value.trim())return t;const a=e.name.toLowerCase().includes(b.value.toLowerCase())||e.description&&e.description.toLowerCase().includes(b.value.toLowerCase());return t&&a})),Q=e=>{w.value=e,ye(e)},G=()=>{b.value.trim()===""?R():_e()},u=v({});ne(()=>!p.value||!u.value?!1:!!(p.value.name!==u.value.name||p.value.tag!==u.value.tag||p.value.text1&&u.value.text1&&p.value.text1.font!==u.value.text1.font||p.value.text2&&u.value.text2&&p.value.text2.font!==u.value.text2.font));const Z=async()=>{try{const e=await C.get(`${x}/fonts`,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});e.data.success?(h.value=e.data.data.map(t=>({label:t.name,value:t.value,url:t.path?`${x}/${t.path}`:null,cssFamily:t.css_family,isDefault:t.is_default||!1})),me()):(console.error("获取字体列表失败:",e.data.error),r.warning("获取字体列表失败，将使用系统字体"),h.value=[])}catch(e){console.error("获取字体列表失败:",e),r.warning("获取字体列表失败，将使用系统字体"),h.value=[]}},j=()=>{const e=h.value.find(a=>a.isDefault);if(e)return e.value;const t=["default","msyh","heiti","songti","kaiti"];for(const a of t)if(h.value.some(l=>l.value===a))return a;return h.value.length>0?h.value[0].value:"default"},me=async()=>{document.querySelectorAll('style[data-font-loader="true"]').forEach(t=>t.remove());const e=h.value.filter(t=>t.url);if(e.length>0){const t=document.createElement("style");t.setAttribute("data-font-loader","true");let a="";const l=[];e.forEach(n=>{a+=`
        @font-face {
          font-family: '${n.value}';
          src: url('${n.url}') format('${pe(n.url)}');
          font-weight: normal;
          font-style: normal;
        }
      `;try{const f=new FontFace(n.value,`url(${n.url})`).load().then(m=>{document.fonts.add(m)}).catch(m=>{console.warn(`字体 ${n.value} 预加载失败:`,m)});l.push(f)}catch(d){console.warn(`字体 ${n.value} 初始化失败:`,d)}}),t.textContent=a,document.head.appendChild(t);try{await Promise.allSettled(l)}catch(n){console.warn("字体加载过程中出现错误:",n)}}},pe=e=>e.endsWith(".ttf")?"truetype":e.endsWith(".otf")?"opentype":e.endsWith(".woff")?"woff":e.endsWith(".woff2")?"woff2":"truetype",Y=e=>{if(!e)return'"微软雅黑", "Microsoft YaHei", Arial, sans-serif';const t=h.value.find(a=>a.value===e);if(t){if(t.url)return`'${e}', "微软雅黑", "Microsoft YaHei", Arial, sans-serif`;if(t.cssFamily)return t.cssFamily}switch(e){case"heiti":return'"黑体", "SimHei", sans-serif';case"songti":return'"宋体", "SimSun", serif';case"msyh":return'"微软雅黑", "Microsoft YaHei", sans-serif';case"kaiti":return'"楷体", "KaiTi", serif';default:return'"微软雅黑", "Microsoft YaHei", Arial, sans-serif'}};re(B,e=>{var t,a,l,n;if(e&&p.value){const d=[];(a=(t=u.value)==null?void 0:t.text1)!=null&&a.font&&d.push(u.value.text1.font),(n=(l=u.value)==null?void 0:l.text2)!=null&&n.font&&d.push(u.value.text2.font),Promise.all(d.map(f=>{try{const m=Y(f);return document.fonts.load(`16px ${m}`)}catch(m){return console.warn(`字体预加载错误: ${m.message}`),Promise.resolve()}})).finally(()=>{setTimeout(()=>{K()},50)})}});const K=()=>{if(!q.value||!p.value)return;const e=q.value,t=e.getContext("2d"),a=new Image;a.onload=()=>{var s,T;const n=e.parentElement.clientWidth,d=400,f=a.width/a.height,m=n/d;let $,k;f>m?($=n,k=$/f):(k=Math.min(d,a.height),$=k*f),e.width=$,e.height=k,t.clearRect(0,0,e.width,e.height),t.drawImage(a,0,0,e.width,e.height);const F=[];(s=u.value.text1)!=null&&s.font&&F.push(u.value.text1.font),(T=u.value.text2)!=null&&T.font&&F.push(u.value.text2.font),F.length>0?Promise.all(F.map(A=>new Promise(z=>{const J=setTimeout(()=>{z()},2e3);try{const oe=Y(A);document.fonts.load(`12px ${oe}`).then(()=>{clearTimeout(J),z()}).catch(()=>{clearTimeout(J),z()})}catch{clearTimeout(J),z()}}))).finally(()=>{ee(t)}):ee(t)},a.src=p.value.previewImage},ee=e=>{u.value.text1&&te(e,u.value.text1,"#f56c6c"),u.value.text2&&te(e,u.value.text2,"#409eff")},te=(e,t,a)=>{const l=q.value,n=t.x*l.width/100,d=t.y*l.height/100,f=t.width*l.width/100,m=t.height*l.height/100;e.strokeStyle=a,e.lineWidth=2,e.strokeRect(n,d,f,m),e.fillStyle=`${a}20`,e.fillRect(n,d,f,m);const $=Y(t.font);e.save(),e.textAlign="center",e.textBaseline="middle";const k=a==="#f56c6c"?"预览文字1":"预览文字2",F=Math.min(f,m),s=Math.max(14,Math.min(24,Math.floor(F*.3)));e.font=`bold ${s}px ${$}`,e.fillStyle=a;const T=n+f/2,A=d+m/2;e.fillText(k,T,A),e.restore()};re([()=>{var e,t;return(t=(e=u.value)==null?void 0:e.text1)==null?void 0:t.font},()=>{var e,t;return(t=(e=u.value)==null?void 0:e.text2)==null?void 0:t.font},()=>{var e;return(e=u.value)==null?void 0:e.name},()=>{var e;return(e=u.value)==null?void 0:e.tag}],()=>{B.value&&q.value&&requestAnimationFrame(()=>{K()})},{deep:!0,immediate:!0}),Re(()=>{R(),ae(),Z()}),Pe(()=>{h.value.forEach(e=>{e.url&&URL.revokeObjectURL(e.url)})});const ge=e=>{p.value=e,I.value=!0},he=async()=>{var e,t;if(p.value)try{const a=await C.delete(`${x}/templates/${p.value.id}`);if(a.data.success){const l=y.value.findIndex(n=>n.id===p.value.id);l!==-1&&y.value.splice(l,1),r.success(`已删除模板: ${p.value.name}`)}else r.error(a.data.error||"删除模板失败")}catch(a){console.error("删除模板失败:",a),r.error("删除模板失败: "+(((t=(e=a.response)==null?void 0:e.data)==null?void 0:t.error)||a.message))}I.value=!1},R=async()=>{var e,t;L.value=!0;try{const a=new Date().getTime(),l=await C.get(`${x}/templates?_t=${a}`);l.data.success?y.value=l.data.templates:(console.error("获取模板列表失败:",l.data.error),r.error(l.data.error||"获取模板列表失败"))}catch(a){console.error("获取模板失败:",a),r.error("获取模板列表失败: "+(((t=(e=a.response)==null?void 0:e.data)==null?void 0:t.error)||a.message))}finally{L.value=!1}},ae=async()=>{try{const e=new Date().getTime(),t=await C.get(`${x}/template-tags?_t=${e}`,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});t.data.success&&t.data.tags&&t.data.tags.length>0?g.value=t.data.tags:t.data.success&&(!t.data.tags||t.data.tags.length===0)?(console.warn("服务器返回的标签列表为空，使用默认标签"),g.value.length===0&&(g.value=[{label:"京东模板",value:"jd"},{label:"百度模板",value:"baidu"},{label:"小说模板",value:"novel"},{label:"夸克模板",value:"quark"}])):(console.error("获取模板标签失败:",t.data.error||"未知错误"),r.warning("获取模板分类失败，将使用默认分类"))}catch(e){console.error("获取模板标签失败:",e),r.warning("获取模板分类失败，将使用默认分类"),g.value.length===0&&(g.value=[{label:"京东模板",value:"jd"},{label:"百度模板",value:"baidu"},{label:"小说模板",value:"novel"},{label:"夸克模板",value:"quark"}])}},ye=async e=>{var a,l,n;if(e==="all"){await R();return}const t=(a=g.value.find(d=>d.value===e))==null?void 0:a.label;if(!t){console.error("未找到对应的标签名称:",e);return}L.value=!0;try{const d=new Date().getTime(),f=await C.get(`${x}/templates?tag=${encodeURIComponent(t)}&_t=${d}`);f.data.success?y.value=f.data.templates:(console.error("获取模板列表失败:",f.data.error),r.error(f.data.error||"获取模板列表失败"))}catch(d){console.error("获取模板失败:",d),r.error("获取模板列表失败: "+(((n=(l=d.response)==null?void 0:l.data)==null?void 0:n.error)||d.message))}finally{L.value=!1}},_e=async()=>{var e,t;if(!b.value.trim()){await R();return}L.value=!0;try{const a=new Date().getTime(),l=await C.get(`${x}/templates?keyword=${b.value}&_t=${a}`);l.data.success?(y.value=l.data.templates,y.value.length===0?r.info(`未找到包含"${b.value}"的模板`):r.success(`搜索到${y.value.length}个包含"${b.value}"的模板`)):r.error(l.data.error||"搜索模板失败")}catch(a){console.error("搜索模板失败:",a),r.error("搜索模板失败: "+(((t=(e=a.response)==null?void 0:e.data)==null?void 0:t.error)||a.message))}finally{L.value=!1}},we=()=>{N.value=!1,O.value=null,D.value=!0},le=e=>{N.value=!0;let t="";if(e.tag){const a=g.value.find(l=>l.label===e.tag);a?t=a.value:(console.warn("未找到匹配标签:",e.tag,"使用原始值"),t=e.tag)}O.value=JSON.parse(JSON.stringify({...e,tag:t,imageSize:e.imageSize||"",previewImage:e.previewImage||"",description:e.description||`${e.name}模板`,text1:e.text1?{...e.text1,font:se(e.text1.font),enabled:e.text1.enabled||!1}:null,text2:e.text2&&Object.keys(e.text2).length>0?{...e.text2,font:se(e.text2.font),enabled:e.text2.enabled||!1}:null,config:e.config||{position:"bottom-right",showLogo:!0,fontSize:24,color:"#000000",fontFamily:j(),bold:!0,enableStroke:!0,strokeColor:"#ffffff",opacity:.5}})),D.value=!0},be=async e=>{if(D.value=!1,await ae(),e){const t=y.value.findIndex(a=>a.id===e.id);if(t>=0)y.value.splice(t,1,e);else if(y.value.unshift(e),e.tag){const a=g.value.find(l=>l.label===e.tag);a&&(w.value=a.value)}}else R()},se=e=>h.value.length<=1?j():h.value.some(a=>a.value===e)?e:j(),xe=async()=>{if(!M.value.name.trim()){r.warning("请输入分类名称");return}const e="tag_"+Date.now(),t={label:M.value.name,value:e};try{const a=await C.post(`${x}/template-tags`,{label:t.label,value:t.value});if(a.data.success)g.value.push(t),w.value=e,r.success(`已添加新分类: ${t.label}`);else{console.error("添加分类到服务器失败:",a.data.error),r.error("添加分类失败: "+(a.data.error||"未知错误"));return}}catch(a){console.error("添加分类到服务器失败:",a),g.value.push(t),w.value=e,r.warning(`已添加新分类: ${t.label} (仅本地有效)`)}M.value.name="",U.value=!1},W=v(!1),_=v({name:"",file:null,textArea:null}),$e=async()=>{if(!_.value.name.trim()){r.warning("请输入自定义字体名称");return}if(!_.value.file){r.warning("请选择字体文件");return}try{const e=new FormData,t=_.value.file.raw;e.append("file",t);const a=_.value.name.trim();e.append("name",a);const l=`font_${Date.now()}`;e.append("value",l),e.append("description",`${a} 字体`),e.append("is_default","false");const n=r({message:"正在上传字体，请稍候...",type:"info",duration:0}),d=await C.post(`${x}/fonts/upload`,e,{headers:{"Content-Type":"multipart/form-data"},timeout:6e4});if(n.close(),d.data.success){r.success("字体上传成功"),await Z();const f=_.value.textArea;B.value&&(f?u.value[f].font=l:u.value.text1?u.value.text1.font=l:u.value.text2&&(u.value.text2.font=l),setTimeout(()=>{K()},200)),W.value=!1,_.value={name:"",file:null,textArea:null}}else r.error(d.data.error||"字体上传失败")}catch(e){console.error("字体上传失败:",e);let t="字体上传失败";e.response?(console.error("响应状态:",e.response.status),console.error("响应数据:",e.response.data),e.response.data&&e.response.data.detail?t+=`: ${e.response.data.detail}`:e.response.data&&e.response.data.error?t+=`: ${e.response.data.error}`:typeof e.response.data=="string"&&(t+=`: ${e.response.data}`)):e.request?(console.error("请求发送但没有收到响应"),t+="：网络请求超时或服务器无响应"):(console.error("请求设置错误:",e.message),t+=`: ${e.message}`),r.error(t);const a=document.querySelector(".el-message--info");a&&a.remove()}},Ce="/api/",ke=e=>e&&e.startsWith("/file/")?`${Ce}${e}`:getImageUrl(e),Fe=async e=>{if(g.value.some(a=>a.value===e.value))r.info(`分类 "${e.label}" 已存在`),w.value=e.value;else try{const a=await C.post(`${x}/template-tags`,{label:e.label,value:e.value});a.data.success?(g.value.push(e),r.success(`已添加新分类: ${e.label}`),w.value=e.value):(console.error("添加分类到服务器失败:",a.data.error),r.error("添加分类失败: "+(a.data.error||"未知错误")))}catch(a){console.error("添加分类到服务器失败:",a),g.value.push(e),r.warning(`已添加新分类: ${e.label} (仅本地有效)`),w.value=e.value}};return(e,t)=>{const a=Ve,l=Ee,n=Se,d=Le,f=Ae,m=Me,$=De,k=Ie,F=Ue;return E(),V("div",Oe,[c("div",je,[c("div",Ye,[c("div",Ke,[t[14]||(t[14]=c("h3",null,"模板分类",-1)),c("div",{class:"add-category-btn",onClick:t[0]||(t[0]=s=>U.value=!0)},[o(a,null,{default:i(()=>[o(P(ie))]),_:1}),t[13]||(t[13]=c("span",null,"新建",-1))])]),c("div",Je,[c("div",{class:ue(["tag-item all-tag",{active:w.value==="all"}]),onClick:t[1]||(t[1]=s=>Q("all"))},t[15]||(t[15]=[c("span",{class:"tag-icon"},null,-1),c("span",{class:"tag-name"},"全部模板",-1)]),2),(E(!0),V(de,null,ce(g.value,(s,T)=>(E(),V("div",{key:T,class:ue(["tag-item",{active:w.value===s.value}]),onClick:A=>Q(s.value)},[t[16]||(t[16]=c("span",{class:"tag-icon"},null,-1)),c("span",Qe,H(s.label),1)],10,Xe))),128))])]),c("div",Ge,[c("div",Ze,[t[18]||(t[18]=c("div",{class:"title-area"},[c("h2",{class:"material-title"}," 模板库 ")],-1)),c("div",et,[o(l,{class:"add-material-btn",onClick:we},{default:i(()=>[o(a,null,{default:i(()=>[o(P(ie))]),_:1}),t[17]||(t[17]=S(" 添加模板 "))]),_:1,__:[17]})])]),c("div",tt,[o(n,{modelValue:b.value,"onUpdate:modelValue":t[2]||(t[2]=s=>b.value=s),placeholder:"搜索模板...",clearable:"",onClear:G,onKeyup:We(G,["enter"])},{prefix:i(()=>[o(a,null,{default:i(()=>[o(P(Ne))]),_:1})]),_:1},8,["modelValue"])]),qe((E(),V("div",at,[c("div",lt,[(E(!0),V(de,null,ce(X.value,(s,T)=>(E(),V("div",{key:T,class:"template-item"},[c("div",{class:"template-image-container",onClick:A=>le(s)},[c("img",{src:ke(s.previewImage),alt:"模板预览",class:"template-image"},null,8,ot),c("div",nt,[o(l,{size:"small",type:"primary",circle:"",onClick:ve(A=>le(s),["stop"])},{default:i(()=>[o(a,null,{default:i(()=>[o(P(ze))]),_:1})]),_:2},1032,["onClick"]),o(l,{size:"small",type:"danger",circle:"",onClick:ve(A=>ge(s),["stop"])},{default:i(()=>[o(a,null,{default:i(()=>[o(P(He))]),_:1})]),_:2},1032,["onClick"])])],8,st),c("div",rt,[c("div",it,H(s.name),1)])]))),128))]),X.value.length===0?(E(),V("div",ut,[o(d,{description:"暂无模板"})])):fe("",!0)])),[[F,L.value]])])]),o(f,{modelValue:I.value,"onUpdate:modelValue":t[4]||(t[4]=s=>I.value=s),title:"确认删除",width:"400px","append-to-body":""},{footer:i(()=>[c("span",dt,[o(l,{onClick:t[3]||(t[3]=s=>I.value=!1)},{default:i(()=>t[19]||(t[19]=[S("取消")])),_:1,__:[19]}),o(l,{type:"danger",onClick:he},{default:i(()=>t[20]||(t[20]=[S("确定")])),_:1,__:[20]})])]),default:i(()=>{var s;return[c("p",null,'确定要删除模板 "'+H((s=p.value)==null?void 0:s.name)+'" 吗？',1)]}),_:1},8,["modelValue"]),o(f,{modelValue:U.value,"onUpdate:modelValue":t[7]||(t[7]=s=>U.value=s),title:"创建新分类",width:"400px"},{footer:i(()=>[c("span",ct,[o(l,{onClick:t[6]||(t[6]=s=>U.value=!1)},{default:i(()=>t[21]||(t[21]=[S("取消")])),_:1,__:[21]}),o(l,{type:"primary",onClick:xe},{default:i(()=>t[22]||(t[22]=[S("确定")])),_:1,__:[22]})])]),default:i(()=>[o($,{model:M.value,"label-position":"top"},{default:i(()=>[o(m,{label:"分类名称",rules:[{required:!0,message:"请输入分类名称",trigger:"blur"}]},{default:i(()=>[o(n,{modelValue:M.value.name,"onUpdate:modelValue":t[5]||(t[5]=s=>M.value.name=s),placeholder:"请输入分类名称"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),o(f,{modelValue:D.value,"onUpdate:modelValue":t[9]||(t[9]=s=>D.value=s),title:N.value?"编辑模板":"添加模板",width:"90%","destroy-on-close":"",top:"4vh"},{default:i(()=>[o(Be,{"template-tags":g.value,"template-data":O.value,"is-edit-mode":N.value,onCancel:t[8]||(t[8]=s=>D.value=!1),onSuccess:be,onAddTag:Fe},null,8,["template-tags","template-data","is-edit-mode"])]),_:1},8,["modelValue","title"]),o(f,{modelValue:W.value,"onUpdate:modelValue":t[12]||(t[12]=s=>W.value=s),title:"上传字体",width:"400px"},{footer:i(()=>[c("span",vt,[o(l,{onClick:t[11]||(t[11]=s=>W.value=!1)},{default:i(()=>t[24]||(t[24]=[S("取消")])),_:1,__:[24]}),o(l,{type:"primary",onClick:$e},{default:i(()=>t[25]||(t[25]=[S("确定")])),_:1,__:[25]})])]),default:i(()=>[o($,{model:_.value,"label-position":"top"},{default:i(()=>[o(m,{label:"自定义字体名称"},{default:i(()=>[o(n,{modelValue:_.value.name,"onUpdate:modelValue":t[10]||(t[10]=s=>_.value.name=s),placeholder:"请输入自定义字体名称"},null,8,["modelValue"])]),_:1}),o(m,{label:"字体文件"},{default:i(()=>[_.value.file?(E(),V("div",ft,H(_.value.file.name),1)):fe("",!0),o(k,{"auto-upload":!1,"show-file-list":!1,"on-change":s=>{_.value.file=s},accept:".ttf,.otf,.woff,.woff2",class:"font-upload-in-dialog"},{default:i(()=>[o(l,{type:"primary"},{default:i(()=>t[23]||(t[23]=[S("重新选择字体文件")])),_:1,__:[23]})]),_:1},8,["on-change"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},At=Te(mt,[["__scopeId","data-v-91e0bc5d"]]);export{At as default};
//# sourceMappingURL=TemplateLibrary-nB6Hz_dD.js.map
