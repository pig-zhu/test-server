import{_ as ut,b as yt,e as bt,f as dt,a as mt,d as pt,E as d,k as wt,F as Gt,aj as It,a7 as xt,aO as Qt,C as Zt,j as ea,i as ta}from"./index-CPV7-EPL.js";import{v as St}from"./el-loading-BYHcIDqY.js";import{E as aa}from"./el-progress-Bq3pXpSz.js";import{E as la}from"./el-divider-B_5bdhNe.js";import{r as h,a4 as $t,A as Se,z as Et,P as Z,s as v,Q as i,N as l,S as s,ah as U,c as Ee,C as ct,q as _,L as F,a1 as Nt,at as sa,u as $,bL as Ye,ap as We,M as te,X as E,aM as me,O as Q,U as ee,cd as Je,cf as Tt,b6 as Ct,as as Ut,F as Ke,cg as ht,aH as _t,bv as rt,bq as it,bK as oa,Y as na,ba as ra}from"./vue-vendor-BgjGt3mC.js";import{T as ia}from"./TemplateForm-CzSvzEWy.js";import{a as $e}from"./axios-xsH4HHeE.js";import"./lodash-BmZg10rb.js";import"./jszip-C7-yN4-L.js";import"./remark-CBsncvHK.js";import"./quill-BeGMbSWh.js";import"./el-row-QNaiA3ZH.js";import"./el-col-CDgPy4_h.js";import"./el-color-picker-BWGeZPMy.js";import"./position-CrPvG4RE.js";import"./el-switch-C90ZVYDS.js";const ca={class:"feedback-dialog-content"},ua={class:"dialog-footer"},da="api/ai",ma={__name:"FeedbackDialog",props:{visible:{type:Boolean,default:!1},taskId:{type:String,default:""},taskName:{type:String,default:""},templateInfo:{type:String,default:""}},emits:["update:visible","success"],setup(qe,{emit:Ne}){const a=qe,N=Ne,x=h(a.visible),P=h(null),y=$t({taskId:a.taskId,taskName:a.taskName,templateInfo:a.templateInfo,description:""}),k=h(!1),j={description:[{required:!0,message:"请填写问题描述",trigger:"blur"},{min:5,message:"问题描述至少5个字符",trigger:"blur"}]};Se(()=>a.visible,w=>{x.value=w,w&&(y.taskId=a.taskId,y.taskName=a.taskName,y.templateInfo=a.templateInfo)}),Se(()=>x.value,w=>{w||N("update:visible",!1)}),Se(()=>a.taskId,w=>{y.taskId=w}),Se(()=>a.taskName,w=>{y.taskName=w}),Se(()=>a.templateInfo,w=>{y.templateInfo=w}),Et(()=>{y.taskId=a.taskId,y.taskName=a.taskName,y.templateInfo=a.templateInfo});const L=()=>{N("update:visible",!1),x.value=!1,P.value&&P.value.resetFields()},H=async()=>{P.value&&await P.value.validate(async w=>{var C,X;if(!w)return!1;k.value=!0;try{const K=await $e.create({baseURL:da,headers:{"Content-Type":"application/json"}}).post("/feedback",{taskId:y.taskId,taskName:y.taskName,templateInfo:y.templateInfo,description:y.description});K.data.success?(d.success("感谢您的反馈，我们会尽快处理"),N("success"),L()):d.error(K.data.error||"提交反馈失败")}catch(T){console.error("提交反馈失败:",T),d.error("提交反馈失败: "+(((X=(C=T.response)==null?void 0:C.data)==null?void 0:X.error)||T.message))}finally{k.value=!1}})};return(w,C)=>{const X=dt,T=bt,K=yt,M=mt,ie=pt;return v(),Z(ie,{modelValue:x.value,"onUpdate:modelValue":C[4]||(C[4]=R=>x.value=R),title:"效果反馈",width:"550px","close-on-click-modal":!1,"destroy-on-close":!0},{footer:i(()=>[l("span",ua,[s(M,{onClick:L},{default:i(()=>C[5]||(C[5]=[U("取消")])),_:1,__:[5]}),s(M,{type:"primary",loading:k.value,onClick:H},{default:i(()=>C[6]||(C[6]=[U("提交反馈")])),_:1,__:[6]},8,["loading"])])]),default:i(()=>[l("div",ca,[s(K,{ref_key:"feedbackFormRef",ref:P,model:y,rules:j,"label-position":"top"},{default:i(()=>[s(T,{label:"任务ID",prop:"taskId"},{default:i(()=>[s(X,{modelValue:y.taskId,"onUpdate:modelValue":C[0]||(C[0]=R=>y.taskId=R),disabled:"",placeholder:"自动填充任务ID"},null,8,["modelValue"])]),_:1}),s(T,{label:"任务名称",prop:"taskName"},{default:i(()=>[s(X,{modelValue:y.taskName,"onUpdate:modelValue":C[1]||(C[1]=R=>y.taskName=R),disabled:"",placeholder:"自动填充任务名称"},null,8,["modelValue"])]),_:1}),s(T,{label:"使用的模板",prop:"templateInfo"},{default:i(()=>[s(X,{modelValue:y.templateInfo,"onUpdate:modelValue":C[2]||(C[2]=R=>y.templateInfo=R),disabled:"",placeholder:"自动填充模板信息"},null,8,["modelValue"])]),_:1}),s(T,{label:"问题描述",prop:"description"},{default:i(()=>[s(X,{modelValue:y.description,"onUpdate:modelValue":C[3]||(C[3]=R=>y.description=R),type:"textarea",rows:4,placeholder:"请详细描述您遇到的问题"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue"])}}},pa=ut(ma,[["__scopeId","data-v-fb5f1a62"]]),va={class:"search-dialog-content"},ga={class:"search-form"},fa={class:"search-results-container"},ha={class:"search-results-header"},_a={class:"result-count"},ka={class:"selection-info"},ya={class:"search-results-grid"},ba=["onClick"],wa={class:"image-container"},Ia=["onClick"],xa=["onClick"],Sa=["src","onError"],$a={key:0,class:"image-error-overlay"},Ea={key:1,class:"empty-search-results"},Na={class:"dialog-footer"},Ta={class:"full-image-container"},Ca=["src"],Ua={class:"full-preview-number"},Fa={class:"full-preview-controls"},Va={__name:"ImageSearchDialog",props:{visible:{type:Boolean,default:!1},selectedImages:{type:Array,default:()=>[]}},emits:["update:visible","select"],setup(qe,{emit:Ne}){const a=qe,N=Ne,x=h({keyword:"",amount:20}),P=Ee({get:()=>a.visible,set:f=>N("update:visible",f)}),y=h(!1),k=h([]),j=h(!1),L=h(null),H=h(!1),w=h([]),C=h(!1),X=h(""),T=h(0);Se(()=>a.visible,f=>{f&&(w.value=[],a.selectedImages&&a.selectedImages.length>0&&(w.value=a.selectedImages.map(m=>({...m}))),k.value.length>0&&K())});const K=()=>{const f=new Set;w.value.forEach(m=>{m.url&&f.add(m.url),m.originalUrl&&f.add(m.originalUrl),m.displayUrl&&f.add(m.displayUrl)}),k.value.forEach(m=>{m.selectionChecked=!0,(f.has(m.url)||f.has(m.originalUrl)||m.url&&f.has(decodeURIComponent(m.url)))&&!M(m)&&w.value.push({...m})})},M=f=>f?w.value.some(m=>m.url===f.url||m.originalUrl===f.originalUrl||m.url===f.originalUrl||m.originalUrl===f.url||m.url&&f.url&&decodeURIComponent(m.url)===decodeURIComponent(f.url)):!1,ie=Ee(()=>k.value.length>0&&k.value.every(f=>M(f))),R=()=>{if(L.value){H.value=!0,d.info("正在取消搜索...");try{L.value.abort(),L.value=null,setTimeout(()=>{y.value=!1,H.value=!1,d.success("已取消搜索")},300)}catch(f){console.error("取消搜索失败:",f),y.value=!1,H.value=!1}}},O=async()=>{if(!x.value.keyword){d.warning("请输入搜索关键词");return}const f=x.value.keyword.trim(),m=x.value.amount;w.value=[],L.value&&L.value.abort(),L.value=new AbortController;const A=L.value.signal;y.value=!0,j.value=!0;try{const W=await fetch(`/api/baidu-image/search?keyword=${encodeURIComponent(f)}&amount=${m}`,{signal:A});if(!W.ok)throw new Error(`搜索请求失败: ${W.status} ${W.statusText}`);const le=await W.json();if(le.code===0&&le.data){const _e=Array.isArray(le.data)?le.data:[];k.value=_e.map((q,Ue)=>{let ke=null,pe=null;try{const ce=q.match(/w=(\d+)/i),V=q.match(/h=(\d+)/i);ce&&ce[1]&&(ke=parseInt(ce[1])),V&&V[1]&&(pe=parseInt(V[1]))}catch(ce){console.error("提取图片尺寸信息失败:",ce)}const Oe=typeof q=="string"&&q.startsWith("/api/baidu-image/proxy");return{originalUrl:q,url:q,width:ke||"未知",height:pe||"未知",source:"百度图片",title:f,index:Ue}}),k.value.length===0?d.info("未找到符合条件的图片，请尝试其他关键词"):(d.success(`找到 ${k.value.length} 张符合条件的图片`),K())}else d.error(le.message||"搜索失败，请重试"),k.value=[]}catch(W){if(W.name==="AbortError")return;console.error("搜索图片失败:",W),d.error(`搜索失败: ${W.message}`),k.value=[]}finally{L.value=null,y.value=!1}},b=f=>{M(f)?w.value=w.value.filter(m=>!(m.url===f.url||m.originalUrl===f.originalUrl||m.url===f.originalUrl||m.originalUrl===f.url||m.url&&f.url&&decodeURIComponent(m.url)===decodeURIComponent(f.url))):w.value.push({...f})},ae=()=>{ie.value?w.value=[]:w.value=k.value.map(f=>({...f}))},ze=()=>{const f=w.value.map(m=>{let A=m.originalUrl;if(typeof A=="string"&&A.startsWith("/api/baidu-image/proxy"))try{const W=A.match(/url=([^&]+)/);W&&W[1]&&(A=decodeURIComponent(W[1]))}catch(W){console.error("从代理URL提取原始URL失败:",W)}return{...m,displayUrl:m.url,url:A}});N("select",f)},Pe=()=>{y.value&&R(),P.value=!1},he=()=>{y.value&&R(),w.value=[]},je=(f,m)=>{console.error(`图片加载失败: ${m.url}`,f),m.loadError=!0,m.retried||(m.retried=!0,m.url=`${m.url}${m.url.includes("?")?"&":"?"}_t=${Date.now()}`,setTimeout(()=>{m.loadError=!1},100))},Ge=(f,m)=>{f.loadError||(X.value=f.url,T.value=m,C.value=!0,document.body.style.overflow="hidden",document.addEventListener("keydown",Ce))},Te=()=>{C.value=!1,document.body.style.overflow="",document.removeEventListener("keydown",Ce)},Ce=f=>{f.key==="Escape"?Te():f.key==="ArrowLeft"?Me():f.key==="ArrowRight"&&de()},Me=()=>{T.value>0&&(T.value--,X.value=k.value[T.value].url)},de=()=>{T.value<k.value.length-1&&(T.value++,X.value=k.value[T.value].url)};return ct(()=>{document.body.style.overflow="",document.removeEventListener("keydown",Ce),L.value&&(L.value.abort(),L.value=null)}),(f,m)=>{const A=wt,W=dt,le=bt,_e=Gt,q=mt,Ue=yt,ke=It,pe=xt,Oe=pt,ce=St;return v(),_(te,null,[s(Oe,{modelValue:P.value,"onUpdate:modelValue":m[2]||(m[2]=V=>P.value=V),title:"搜索底图",width:"85%",top:"5vh",class:"image-search-dialog",onClose:he},{footer:i(()=>[l("span",Na,[s(q,{onClick:Pe},{default:i(()=>m[7]||(m[7]=[U("取消")])),_:1,__:[7]}),s(q,{type:"primary",onClick:ze,disabled:w.value.length===0},{default:i(()=>[U(" 确定 (已选择 "+E(w.value.length)+" 张) ",1)]),_:1},8,["disabled"])])]),default:i(()=>[l("div",va,[l("div",ga,[s(Ue,{model:x.value,inline:""},{default:i(()=>[s(le,{label:"搜索关键词"},{default:i(()=>[s(W,{modelValue:x.value.keyword,"onUpdate:modelValue":m[0]||(m[0]=V=>x.value.keyword=V),placeholder:"请输入搜索关键词",clearable:"",onKeyup:sa(O,["enter"])},{prefix:i(()=>[s(A,null,{default:i(()=>[s($(Ye))]),_:1})]),_:1},8,["modelValue"])]),_:1}),s(le,{label:"搜索数量"},{default:i(()=>[s(_e,{modelValue:x.value.amount,"onUpdate:modelValue":m[1]||(m[1]=V=>x.value.amount=V),min:1,max:50,step:5,"controls-position":"right"},null,8,["modelValue"])]),_:1}),s(le,null,{default:i(()=>[y.value?(v(),Z(q,{key:1,type:"danger",onClick:R,disabled:H.value},{default:i(()=>[s(A,null,{default:i(()=>[s($(We))]),_:1}),m[5]||(m[5]=U(" 取消搜索 "))]),_:1,__:[5]},8,["disabled"])):(v(),Z(q,{key:0,type:"primary",onClick:O,loading:y.value,disabled:!x.value.keyword||H.value},{default:i(()=>[s(A,null,{default:i(()=>[s($(Ye))]),_:1}),m[4]||(m[4]=U(" 搜索 "))]),_:1,__:[4]},8,["loading","disabled"]))]),_:1})]),_:1},8,["model"])]),Nt((v(),_("div",fa,[k.value.length>0?(v(),_(te,{key:0},[l("div",ha,[l("div",_a,"共找到 "+E(k.value.length)+" 张图片",1),l("div",ka,[w.value.length>0?(v(),Z(ke,{key:0,type:"info",effect:"plain"},{default:i(()=>[U(" 已选择: "+E(w.value.length)+"张 ",1)]),_:1})):F("",!0),s(q,{type:"primary",size:"small",onClick:ae,disabled:k.value.length===0},{default:i(()=>[U(E(ie.value?"取消全选":"全选"),1)]),_:1},8,["disabled"])])]),l("div",ya,[(v(!0),_(te,null,me(k.value,(V,Be)=>(v(),_("div",{key:Be,class:Q(["search-result-item",{selected:M(V)}]),onClick:ye=>b(V)},[l("div",wa,[l("div",{class:"cute-checkbox",onClick:ee(ye=>b(V),["stop"])},[l("div",{class:Q(["checkbox-inner",{checked:M(V)}])},[M(V)?(v(),Z(A,{key:0},{default:i(()=>[s($(Je))]),_:1})):F("",!0)],2)],8,Ia),l("div",{class:"image-wrapper",onClick:ee(ye=>Ge(V,Be),["stop"])},[l("img",{src:V.url,alt:"搜索结果",class:"result-image",onError:ye=>je(ye,V),loading:"lazy"},null,40,Sa),V.loadError?(v(),_("div",$a,[s(A,null,{default:i(()=>[s($(Tt))]),_:1}),m[6]||(m[6]=l("span",null,"图片加载失败",-1))])):F("",!0)],8,xa)])],10,ba))),128))])],64)):y.value?F("",!0):(v(),_("div",Ea,[s(pe,{description:"暂无搜索结果"},{description:i(()=>[l("p",null,E(j.value?"未找到匹配的图片，请尝试其他关键词":"请输入关键词搜索底图"),1)]),_:1})]))])),[[ce,y.value]])])]),_:1},8,["modelValue"]),C.value?(v(),_("div",{key:0,class:"full-image-preview",onClick:Te},[l("div",Ta,[l("img",{src:X.value,alt:"全屏预览",class:"full-preview-image"},null,8,Ca),l("div",Ua,E(T.value+1)+"/"+E(k.value.length),1),l("button",{class:"full-preview-close",onClick:ee(Te,["stop"])},[s(A,null,{default:i(()=>[s($(We))]),_:1})]),l("div",Fa,[s(q,{circle:"",onClick:ee(Me,["stop"]),disabled:T.value===0},{default:i(()=>[s(A,null,{default:i(()=>[s($(Ct))]),_:1})]),_:1},8,["disabled"]),s(q,{circle:"",onClick:ee(de,["stop"]),disabled:T.value>=k.value.length-1},{default:i(()=>[s(A,null,{default:i(()=>[s($(Ut))]),_:1})]),_:1},8,["disabled"])]),s(q,{class:"full-preview-select",type:M(k.value[T.value])?"danger":"primary",onClick:m[3]||(m[3]=ee(V=>b(k.value[T.value]),["stop"]))},{default:i(()=>[U(E(M(k.value[T.value])?"取消选择":"选择此图片"),1)]),_:1},8,["type"])])])):F("",!0)],64)}}},Da=ut(Va,[["__scopeId","data-v-3a7dd900"]]),kt=""+new URL("default-preview-B75fp3fw.jpg",import.meta.url).href,La={class:"create-task-container"},Ra={class:"two-column-layout"},Aa={class:"left-config-area"},Wa={class:"left-content-wrapper"},qa={class:"cards-container"},za={class:"config-card"},Pa={class:"card-header"},ja={class:"panel-switch-wrapper"},Ma={class:"card-content"},Oa={class:"section"},Ba={class:"input-wrapper"},Ha={class:"section"},Xa={class:"section-header"},Ka={key:0,class:"template-count"},Ja={class:"image-upload-wrapper"},Ya={class:"upload-box"},Ga={key:0,class:"selected-name"},Qa={key:1,class:"upload-placeholder"},Za={key:0,class:"section"},el={class:"size-selector"},tl={class:"section"},al={class:"image-source-selector"},ll={class:"image-source-capsule"},sl={key:0,class:"ai-image-config"},ol={class:"upload-area"},nl={key:1,class:"excel-info-inner"},rl={class:"excel-info-text"},il={class:"upload-actions"},cl={key:1,class:"custom-image-config"},ul={class:"upload-area"},dl={key:1,class:"image-info-inner"},ml={class:"image-info-text"},pl={key:2,class:"search-image-config"},vl={class:"search-image-placeholder"},gl={key:0,class:"selected-images-info"},fl={key:0,class:"search-text-input"},hl={class:"section"},_l={class:"naming-rule-selector"},kl={class:"naming-input-container"},yl={class:"naming-variables"},bl={class:"variables-container"},wl={class:"naming-rule-hint"},Il={class:"card-actions"},xl=["disabled"],Sl={class:"btn-icon"},$l={class:"btn-text"},El={class:"right-preview-area"},Nl={class:"preview-header"},Tl={class:"actions-container"},Cl={class:"preview-content"},Ul={class:"result-container"},Fl={key:0,class:"result-grid"},Vl={class:"result-image-wrapper"},Dl=["src","onClick"],Ll=["onClick"],Rl={key:1,class:"loading-spinner"},Al={key:1,class:"regenerating-overlay"},Wl={class:"result-info"},ql={class:"result-name"},zl={class:"result-time"},Pl={class:"loading-content-wrapper"},jl={class:"loading-text"},Ml={key:0,class:"progress-bar-container"},Ol={key:0,class:"progress-text"},Bl={key:1,class:"generation-status"},Hl={key:2,class:"queue-status"},Xl={key:2,class:"empty-result"},Kl={class:"template-dialog-content"},Jl={class:"resource-layout"},Yl={class:"left-panel"},Gl={class:"my-tags-list"},Ql=["onClick"],Zl={class:"tag-name"},es={class:"right-panel"},ts={class:"template-list-header"},as={class:"header-search"},ls={class:"header-actions"},ss={class:"template-list-container"},os={class:"template-grid"},ns=["onClick"],rs={class:"template-image-container"},is=["src"],cs={key:0,class:"template-selected-badge"},us={class:"template-info"},ds={class:"template-name"},ms={key:0,class:"empty-state"},ps={class:"dialog-footer"},vs=["src"],gs={class:"full-preview-number"},fs={class:"full-preview-controls"},G="/api/ai",hs={__name:"CreateTask",setup(qe){const Ne="/api/";h({src:kt,width:512,height:512});const a=$t({imageSourceType:"ai",excelFile:null,imageFiles:[],searchImageUrls:[],imageFormat:"single",panelMode:"single",imageSize:"1:1",templateIds:[],selectedTemplateNames:[],taskName:"",customImageName:"{taskName}_{index}",taskId:""}),N=h(!1),x=h(!1),P=h(!1),y=h(!1),k=h(0),j=h([]),L=h([]),H=h(0),w=h([]),C=h(!1),X=Ee(()=>a.imageSourceType==="ai"?[{label:"{任务名}",value:"{taskName}"},{label:"{序号}",value:"{index}"},{label:"{日期}",value:"{date}"},{label:"{文本1}",value:"{text1}"}]:a.imageSourceType==="search"?[{label:"{任务名}",value:"{taskName}"},{label:"{序号}",value:"{index}"},{label:"{日期}",value:"{date}"},{label:"{文案}",value:"{text}"}]:[{label:"{任务名}",value:"{taskName}"},{label:"{序号}",value:"{index}"},{label:"{日期}",value:"{date}"},{label:"{底图文件名}",value:"{original_filename}"}]),T=h([]),K=h("all"),M=h(""),ie=h(!1),R=h([]),O=h([]),b=h([]),ae=t=>t?t.replace(/[\\/:*?"<>|]/g,"_").replace(/\s+/g,"_").substring(0,50):"",ze=t=>{K.value=t,t==="all"?he():Ge(t)},Pe=()=>{if(!M.value.trim()){K.value==="all"?O.value=R.value:O.value=R.value.filter(e=>e.tag===K.value);return}const t=M.value.toLowerCase();O.value=R.value.filter(e=>e.name.toLowerCase().includes(t)||e.description&&e.description.toLowerCase().includes(t))},he=async()=>{var t,e;ie.value=!0;try{const o=new Date().getTime(),u=await $e.get(`${G}/templates?_t=${o}`);u.data.success?(R.value=u.data.templates,O.value=u.data.templates):d.error("获取模板列表失败")}catch(o){console.error("获取模板失败:",o),d.error("获取模板列表失败: "+(((e=(t=o.response)==null?void 0:t.data)==null?void 0:e.error)||o.message))}finally{ie.value=!1}},je=async()=>{try{const t=await $e.get(`${G}/template-tags`);t.data.success&&t.data.tags.length>0&&(T.value=t.data.tags)}catch(t){console.error("获取模板标签失败:",t)}},Ge=async t=>{ie.value=!0;try{const e=await $e.get(`${G}/templates?tag=${t}`);e.data.success?O.value=e.data.templates:d.error("获取模板列表失败")}catch(e){console.error("获取模板失败:",e),d.error("获取模板列表失败")}finally{ie.value=!1}},Te=async t=>{y.value=!1,await he();const e=R.value.find(o=>o.id===t.id);e?(a.templateIds.push(e.id),a.selectedTemplateNames.push(e.name),e.imageSize&&(a.imageSize=e.imageSize),d.success(`已自动选择新模板: ${e.name}`)):d.warning("模板已添加但未能自动选择，请手动选择模板")},Ce=()=>{if(a.templateIds.length===0){P.value=!1;return}if(k.value>0&&a.templateIds.length>k.value){d.warning(`选择的模板数量(${a.templateIds.length})不能超过Excel行数(${k.value})`);return}if(k.value>0&&a.templateIds.length<k.value&&d.info(`已选择${a.templateIds.length}个模板，将循环使用这些模板生成${k.value}张图片`),a.templateIds.length>0){const t=R.value.find(e=>e.id===a.templateIds[0]);t&&(t.imageSize&&(a.imageSize=t.imageSize),a.watermarkImage&&(a.watermarkImage=null))}d.success(`已选择 ${a.templateIds.length} 个模板`),P.value=!1},Me=t=>{if(!t)return"";const e=new Date(t);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`},de=async t=>{const e=[];if(!t||!Array.isArray(t))return console.error("传入的结果不是数组"),[];for(let o=0;o<t.length;o++){const u=t[o];try{if(!u){console.warn(`第${o+1}项结果为空`);continue}const n=u.generated_index!==void 0?u.generated_index:o,p=u.success!==!1,r=f(u,n);if(p){let g=null;if(u.imageUrl?g=u.imageUrl:u.image_path?g=u.image_path:u.image&&typeof u.image=="string"&&(g=u.image),g){e.push({...u,index:n,name:r,imageUrl:g,time:new Date().getTime()});continue}if(u.task_id||a.taskId){const I=`/ai/static/images/text_added_${u.task_id||a.taskId}_${n+1}.png`;e.push({...u,index:n,name:r,imageUrl:I,time:new Date().getTime()})}else{console.error("图片数据缺失且无法构建fallback URL:",u);const S=`图片_${(n+1).toString().padStart(3,"0")}.png`;e.push({...u,index:n,name:S,imageUrl:null,error:"图片数据格式不正确",time:new Date().getTime()})}}else{console.warn(`第${n+1}项处理失败:`,u.error||"未知错误");const g=`图片_${(n+1).toString().padStart(3,"0")}.png`;e.push({...u,index:n,name:g,imageUrl:null,error:u.error||"图片生成失败",time:new Date().getTime()})}}catch(n){console.error(`处理第${o+1}项时出错:`,n);const p=`图片_${(o+1).toString().padStart(3,"0")}.png`;e.push({...u,index:o,name:p,imageUrl:null,error:n.message||"图片处理失败",time:new Date().getTime()})}}return e},f=(t,e)=>{if(!a.customImageName)return`${a.taskName||"图片"}_${(e+1).toString().padStart(3,"0")}.png`;let o=a.customImageName;const u=a.taskName||"未命名任务",n=(e+1).toString().padStart(3,"0"),p=new Date,r=`${p.getFullYear()}${(p.getMonth()+1).toString().padStart(2,"0")}${p.getDate().toString().padStart(2,"0")}`,g=`${p.getHours().toString().padStart(2,"0")}${p.getMinutes().toString().padStart(2,"0")}`,S=I=>{if(!I)return"";const Y=I.indexOf("@");return Y===-1?I:I.substring(0,Y)};if(a.imageSourceType==="ai"){const I=be(t.prompt||""),Y=be(t.text1||""),oe=be(t.text2||"");o=o.replace(/{taskName}/g,ae(u)).replace(/{index}/g,n).replace(/{date}/g,r).replace(/{time}/g,g).replace(/{text1}/g,ae(Y)).replace(/{text2}/g,ae(oe)).replace(/{prompt}/g,ae(I))}else if(a.imageSourceType==="search"){const I=ge.value.trim()||`search_image_${e+1}`;o=o.replace(/{taskName}/g,ae(u)).replace(/{index}/g,n).replace(/{date}/g,r).replace(/{time}/g,g).replace(/{text}/g,ae(I))}else{let I=t.original_filename||(a.imageFiles[e]?a.imageFiles[e].name.substring(0,a.imageFiles[e].name.lastIndexOf("."))||`image_${e+1}`:`image_${e+1}`);I=S(I),o=o.replace(/{taskName}/g,ae(u)).replace(/{index}/g,n).replace(/{date}/g,r).replace(/{time}/g,g).replace(/{original_filename}/g,ae(I))}return!o.endsWith(".png")&&!o.endsWith(".jpg")&&(o+=".png"),o},m=async()=>{const t=[];if(a.taskName||t.push("任务名称"),a.imageSourceType==="ai"){if(a.excelFile||t.push("提示词Excel"),a.templateIds.length===0&&!a.imageSize&&t.push("底图尺寸"),k.value>50){d.error("提示词数量超过限制，最多支持单次生成50张图片");return}if(a.excelFile&&k.value<a.templateIds.length){d.warning(`Excel数据行数(${k.value}行)不能少于模板数量(${a.templateIds.length}个)，请增加数据行数或减少模板数量`);return}}else if(a.imageSourceType==="custom"){if(a.imageFiles.length===0&&t.push("底图上传"),a.imageFiles.length>0&&a.imageFiles.length<a.templateIds.length){d.warning(`图片数量(${a.imageFiles.length}张)不能少于模板数量(${a.templateIds.length}个)，请上传更多图片或减少模板数量`);return}}else if(a.imageSourceType==="search"&&(a.searchImageUrls.length===0&&t.push("底图选择"),a.searchImageUrls.length>0&&!ge.value.trim()&&t.push("底图文案"),a.searchImageUrls.length>0&&a.searchImageUrls.length<a.templateIds.length)){d.warning(`图片数量(${a.searchImageUrls.length}张)不能少于模板数量(${a.templateIds.length}个)，请选择更多图片或减少模板数量`);return}if(t.length>0){d.error(`请完成必填项: ${t.join("、")}`);return}J.value=0,N.value=!0,x.value=!0,b.value=[];try{a.imageSourceType==="ai"?await A():a.imageSourceType==="custom"?await W():a.imageSourceType==="search"&&await le()}catch(e){console.error("提交失败:",e),d.error("任务创建失败，请重试"),N.value=!1,x.value=!1}},A=async()=>{try{const t=new FileReader;t.onload=async e=>{try{const o=new Uint8Array(e.target.result),u=XLSX.read(o,{type:"array"}),n=u.SheetNames[0],p=u.Sheets[n],r=XLSX.utils.sheet_to_json(p);if(r.length===0){d.error("Excel文件为空或格式不正确"),N.value=!1,x.value=!1;return}const g=r[0];if(!("prompt"in g||"提示词"in g)){d.error('Excel文件中缺少"prompt"或"提示词"列'),N.value=!1,x.value=!1;return}const I=r.map((B,c)=>{const re=B.prompt||B.提示词||"",fe=B.text1||B.文本1||"",Ae=B.text2||B.文本2||"";return{prompt:re,text1:fe,text2:Ae}}),Y={task_name:a.taskName,excel_data:I,template_ids:a.templateIds,image_format:a.imageFormat,image_size:a.imageSize,text_settings:{has_text1:!0,has_text2:!0},filename_pattern:a.customImageName||"{taskName}_{index}",image_source_type:"ai"},oe=await fetch(`${G}/excel_batch_process_stream`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Y)});if(!oe.ok){const B=await oe.text();throw new Error(`请求失败: ${oe.status} ${B}`)}const ne=oe.body.getReader(),Re=new TextDecoder,Ie=async({done:B,value:c})=>{if(B){N.value=!1,x.value=!1,D.value=!1;return}const fe=Re.decode(c,{stream:!0}).split(`

`);for(const Ae of fe)if(Ae.startsWith("data:"))try{const z=JSON.parse(Ae.substring(5).trim());switch(z.task_id&&(a.taskId=z.task_id),z.status){case"started":d.info(`开始处理 ${z.total} 张图片`),z.queued?(D.value=!0,Le.value=z.queue_position||1):D.value=!1;break;case"progress":if(J.value=Math.round(z.progress),D.value=!1,z.current_results&&z.current_results.length>0){const xe=z.current_results[0],ft=b.value.length,Yt=f(xe,ft);b.value.push({...xe,index:ft,name:Yt,imageUrl:xe.imageUrl||xe.image_path,time:new Date().getTime()})}break;case"error":console.error("生成过程中出现错误:",z.error),d.warning(`处理过程中出现错误: ${z.error||"未知错误"}`);break;case"completed":break;case"end":if(z.results&&z.results.length>0){const xe=await de(z.results);b.value=xe,d.success("所有图片生成完成！")}N.value=!1,x.value=!1,D.value=!1;break;default:break}}catch(z){console.error("解析SSE数据错误:",z,Ae)}ne.read().then(Ie)};ne.read().then(Ie)}catch(o){console.error("读取Excel文件失败:",o),d.error("读取Excel文件失败，请检查文件格式"),N.value=!1,x.value=!1}},t.readAsArrayBuffer(a.excelFile)}catch(t){console.error("读取Excel文件失败:",t),d.error("读取Excel文件失败，请检查文件格式"),N.value=!1,x.value=!1}},W=async()=>{try{const t=new FormData;t.append("taskName",a.taskName),t.append("customImageName",a.customImageName),t.append("image_source_type","custom"),a.templateIds.forEach(p=>{t.append("templateIds[]",p)}),a.imageFiles.forEach((p,r)=>{t.append(`images[${r}]`,p);const g=p.name.substring(0,p.name.lastIndexOf("."))||`image_${r+1}`;t.append(`original_filenames[${r}]`,g),t.append(`texts[${r}]`,g)}),console.group("自定义底图任务提交数据"),console.groupEnd();const o=await(await fetch(`${G}/custom-image-watermark`,{method:"POST",body:t})).json();if(!o.success||!o.task_id){d.error(`任务创建失败: ${o.error||"未知错误"}`),x.value=!1,N.value=!1;return}a.taskId=o.task_id;const u=`${G}/custom-image-watermark/stream?task_id=${a.taskId}`,n=new EventSource(u);window.imageWatermarkEventSource=n,n.onmessage=async p=>{try{const r=JSON.parse(p.data);switch(r.status){case"started":d.info(`开始处理 ${r.total} 张图片`),r.queued?(D.value=!0,Le.value=r.queue_position||1):D.value=!1;break;case"progress":if(J.value=Math.round(r.progress),D.value=!1,r.current_results&&r.current_results.length>0){const g=r.current_results[0],S=await de([g]);S.length>0&&(b.value.push(S[0]),d.info(`已生成 ${b.value.length} 张图片`))}break;case"item_completed":if(r.result){const g=b.value.length,S={...r.result,generated_index:g},I=await de([S]);I.length>0&&(b.value.push(I[0]),d.info(`已生成 ${b.value.length} 张图片`))}break;case"error":d.warning(`处理过程中出现错误: ${r.error||"未知错误"}`);break;case"completed":d.success("所有图片生成完成！"),N.value=!1,x.value=!1,D.value=!1,n.close(),window.imageWatermarkEventSource=null;break;case"end":N.value=!1,x.value=!1,D.value=!1,n.close(),window.imageWatermarkEventSource=null;break;default:break}}catch(r){console.error("解析SSE数据错误:",r,p.data)}},n.onerror=p=>{console.error("SSE连接错误:",p),d.error("SSE连接错误，请刷新页面重试"),N.value=!1,x.value=!1,D.value=!1,n.close(),window.imageWatermarkEventSource=null}}catch(t){console.error("提交失败",t),d.error("任务创建失败，请重试"),x.value=!1,N.value=!1}},le=async()=>{try{const t=new FormData;t.append("taskName",a.taskName),t.append("customImageName",a.customImageName),t.append("image_source_type","search"),a.templateIds.forEach(p=>{t.append("templateIds[]",p)}),a.searchImageUrls.forEach((p,r)=>{t.append(`image_urls[${r}]`,p);const g=ge.value.trim()||`搜索图片_${r+1}`;t.append(`texts[${r}]`,g)}),console.group("搜索底图任务提交数据"),console.groupEnd();const o=await(await fetch(`${G}/search-image-watermark`,{method:"POST",body:t})).json();if(!o.success||!o.task_id){d.error(`任务创建失败: ${o.error||"未知错误"}`),x.value=!1,N.value=!1;return}a.taskId=o.task_id;const u=`${G}/search-image-watermark/stream?task_id=${a.taskId}`,n=new EventSource(u);window.imageWatermarkEventSource=n,n.onmessage=async p=>{try{let r;const g=p.data;if(typeof g=="string")if(g.startsWith("data:")){const S=g.substring(5).trim();r=JSON.parse(S)}else r=JSON.parse(g);else r=g;switch(r.status){case"started":d.info(`开始处理 ${r.total} 张图片`),r.queued?(D.value=!0,Le.value=r.queue_position||1):D.value=!1;break;case"progress":if(J.value=Math.round(r.progress),D.value=!1,r.current_results&&r.current_results.length>0){const S=r.current_results[0],I=await de([S]);I.length>0&&(b.value.push(I[0]),d.info(`已生成 ${b.value.length} 张图片`))}break;case"item_completed":if(r.result){const S=b.value.length,I={...r.result,generated_index:S},Y=await de([I]);Y.length>0&&(b.value.push(Y[0]),d.info(`已生成 ${b.value.length} 张图片`))}break;case"error":d.warning(`处理过程中出现错误: ${r.error||"未知错误"}`);break;case"completed":d.success("所有图片生成完成！"),N.value=!1,x.value=!1,D.value=!1,n.close(),window.imageWatermarkEventSource=null;break;case"end":N.value=!1,x.value=!1,D.value=!1,n.close(),window.imageWatermarkEventSource=null;break;default:break}}catch(r){console.error("解析SSE数据错误:",r,p.data)}},n.onerror=p=>{console.error("SSE连接错误:",p),d.error("SSE连接错误，请刷新页面重试"),N.value=!1,x.value=!1,D.value=!1,n.close(),window.imageWatermarkEventSource=null}}catch(t){console.error("提交失败",t),d.error("任务创建失败，请重试"),x.value=!1,N.value=!1}};ct(()=>{document.removeEventListener("keydown",De)});const _e=()=>{a.excelFile=null,k.value=0,L.value=[],j.value=[],d.info("已移除Excel文件")},q=(t,e)=>{ue.value=t,se.value=e,Fe.value=!0,document.body.classList.add("no-scroll"),document.addEventListener("keydown",De),Ke(()=>{const o=document.querySelector(".full-image-container");o&&Ve(t)?o.classList.add("tall-image"):o&&o.classList.remove("tall-image")})},Ue=async()=>new Promise(t=>{if(C.value){t();return}if(document.querySelector('script[src*="lottie-player.js"]'))C.value=!0,t();else{const e=document.createElement("script");e.src="/lottie-player.js",e.async=!0,e.onload=()=>{C.value=!0,t()},e.onerror=o=>{console.error("Lottie Player 本地脚本加载失败，尝试使用CDN:",o);const u=document.createElement("script");u.src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js",u.async=!0,u.onload=()=>{C.value=!0,t()},u.onerror=n=>{console.error("Lottie Player CDN脚本加载失败:",n),t()},document.head.appendChild(u)},document.head.appendChild(e)}}),ke=t=>{const e=a.templateIds.indexOf(t.id);e===-1?(a.templateIds.push(t.id),a.selectedTemplateNames.push(t.name)):(a.templateIds.splice(e,1),a.selectedTemplateNames.splice(e,1))},pe=Ee(()=>O.value.length>0&&O.value.every(t=>a.templateIds.includes(t.id))),Oe=()=>{pe.value?O.value.forEach(t=>{const e=a.templateIds.indexOf(t.id);if(e!==-1){a.templateIds.splice(e,1);const o=a.selectedTemplateNames.indexOf(t.name);o!==-1&&a.selectedTemplateNames.splice(o,1)}}):O.value.forEach(t=>{a.templateIds.includes(t.id)||(a.templateIds.push(t.id),a.selectedTemplateNames.push(t.name))})},ce=()=>{window.imageWatermarkEventSource&&(window.imageWatermarkEventSource.close(),window.imageWatermarkEventSource=null),a.imageSourceType,Object.assign(a,{excelFile:null,imageFormat:"single",imageSize:"1:1",panelMode:"single",searchImageUrls:[],imageSourceType:"ai",templateIds:[],selectedTemplateNames:[],watermarkImage:null,taskId:"",taskName:"",customImageName:"{taskName}_{index}"}),k.value=0,H.value=0,j.value=[],L.value=[],a.imageFiles=[],w.value=[],x.value=!1,N.value=!1,D.value=!1,Le.value=0,Xt.value=0,J.value=0,Fe.value=!1,se.value=0,ue.value=null,He.value=!1,Ze.value="",et.value="",tt.value={},ve.value=!1,we.value=[],ge.value="",b.value=[],document.removeEventListener("keydown",De),document.body.classList.remove("no-scroll"),Ke(()=>{try{ot.value&&ot.value.clearFiles(),nt.value&&nt.value.clearFiles();const t=n=>{const p=document.querySelector(n);p&&(p.style.display="none")},e=(n,p="flex")=>{const r=document.querySelector(n);r&&(r.style.display=p)};t(".excel-info-inner"),t(".image-info-inner"),t(".selected-images-info"),e(".ai-image-config .upload-placeholder"),e(".custom-image-config .upload-placeholder"),e(".ai-image-config","block"),t(".custom-image-config"),t(".search-image-config");const o=document.querySelectorAll(".option-item"),u=document.querySelector(".option-indicator");o.length>=3&&(o.forEach((n,p)=>{p===0?n.classList.add("active"):n.classList.remove("active")}),u&&(u.className="option-indicator",u.classList.remove("at-custom"),u.classList.remove("at-search"))),document.querySelectorAll('input[type="text"]').forEach(n=>{n.placeholder==="请输入任务名称"?(n.value="",n.dispatchEvent(new Event("input",{bubbles:!0}))):n.placeholder==="请输入自定义命名规则"&&(n.value="{taskName}_{index}",n.dispatchEvent(new Event("input",{bubbles:!0})))}),setTimeout(()=>{const n=(p,r)=>{const g=document.querySelector(`${p} .el-upload-dragger`);if(g){const S=g.querySelector(".upload-icon"),I=g.querySelector(".upload-text");(!S||!I)&&(g.innerHTML=`
                <el-icon class="upload-icon"><Upload /></el-icon>
                <div class="upload-text">${r}</div>
              `)}};n(".ai-image-config .upload-drag-area","上传/拖动Excel文件到此处"),n(".custom-image-config .upload-drag-area","上传/拖动图片到此处"),document.querySelectorAll('input[type="file"]').forEach(p=>{p.value=""})},50)}catch(t){console.error("重置UI出错:",t)}}),d.success("表单已重置")},V=t=>{if(!a.customImageName){a.customImageName=t;return}const e=document.querySelector(".naming-input-container input");if(e===document.activeElement){const o=e.selectionStart,u=e.selectionEnd;a.customImageName=a.customImageName.substring(0,o)+t+a.customImageName.substring(u),setTimeout(()=>{e.selectionStart=e.selectionEnd=o+t.length,e.focus()},0)}else a.customImageName+=t},Be=()=>{if(!a.customImageName)return"自定义_001.png";let t=a.customImageName;const e=a.taskName||"植物水果",o=new Date,u=`${o.getFullYear()}${(o.getMonth()+1).toString().padStart(2,"0")}${o.getDate().toString().padStart(2,"0")}`,n=`${o.getHours().toString().padStart(2,"0")}${o.getMinutes().toString().padStart(2,"0")}`,p=r=>{if(!r)return"";const g=r.indexOf("@");return g===-1?r:r.substring(0,g)};if(a.imageSourceType==="ai"){let r="Text1",g="Text2",S="森林风景";if(k.value>0&&j.value.length>0){const I=j.value[0];I.prompt&&(S=be(I.prompt),S.length>30&&(S=S.substring(0,27)+"...")),I.text1&&(r=be(I.text1),r.length>30&&(r=r.substring(0,27)+"...")),I.text2&&(g=be(I.text2),g.length>30&&(g=g.substring(0,27)+"..."))}r=p(r),g=p(g),S=p(S),t=t.replace(/{taskName}/g,e).replace(/{index}/g,"001").replace(/{date}/g,u).replace(/{time}/g,n).replace(/{text1}/g,r).replace(/{text2}/g,g).replace(/{prompt}/g,S)}else if(a.imageSourceType==="search"){let r=ge.value.trim()||"搜索图片文案";r.length>20&&(r=r.substring(0,17)+"..."),t=t.replace(/{taskName}/g,e).replace(/{index}/g,"001").replace(/{date}/g,u).replace(/{time}/g,n).replace(/{text}/g,r)}else{let r=a.imageFiles.length>0&&a.imageFiles[0].name.substring(0,a.imageFiles[0].name.lastIndexOf("."))||"image_1";t=t.replace(/{taskName}/g,ae(e)).replace(/{index}/g,"001").replace(/{date}/g,u).replace(/{time}/g,n).replace(/{original_filename}/g,p(r))}return!t.endsWith(".png")&&!t.endsWith(".jpg")&&(t+=".png"),t},ye=t=>{a.excelFile=t.raw,L.value=[t];const e=new FileReader;return e.onload=async o=>{try{const u=new Uint8Array(o.target.result),n=XLSX.read(u,{type:"array"}),p=n.SheetNames[0],r=n.Sheets[p],g=XLSX.utils.sheet_to_json(r);if(g.length===0){d.error("Excel文件为空或格式不正确");return}if(g.length>50){d.error("提示词数量超过限制，最多支持50条数据生成50张图片，请精简数据后重新上传"),a.excelFile=null,L.value=[],k.value=0;return}const S=g[0],I="prompt"in S||"提示词"in S,Y="text1"in S||"文本1"in S,oe="text2"in S||"文本2"in S;if(!I){d.error('Excel文件中缺少"prompt"或"提示词"列');return}j.value=g.map((ne,Re)=>{const Ie=ne.prompt||ne.提示词||"",B=ne.text1||ne.文本1||"",c=ne.text2||ne.文本2||"";return{prompt:Ie,text1:B,text2:c}}),k.value=g.length,d.success(`成功读取Excel文件，共${g.length}行数据`)}catch(u){console.error("读取Excel文件失败:",u),d.error("读取Excel文件失败，请检查文件格式")}},e.readAsArrayBuffer(t.raw),!1},Ft=t=>t.raw?t.raw.type.startsWith("image/")?t.raw.size/1024/1024<10?(a.imageFiles.push(t.raw),w.value.push(t),H.value=a.imageFiles.length,!1):(d.error("图片大小不能超过10MB!"),!1):(d.error("只能上传图片文件！"),!1):void 0,Vt=t=>{const e=a.imageFiles.findIndex(u=>u.uid===t.uid||u.name===t.name);e!==-1&&a.imageFiles.splice(e,1);const o=w.value.findIndex(u=>u.uid===t.uid);o!==-1&&w.value.splice(o,1),H.value=a.imageFiles.length,d.info(`已移除图片: ${t.name}`)},Dt=()=>{a.imageFiles=[],w.value=[],H.value=0,d.info("已清除所有图片")},Lt=t=>{d.warning(`最多只能上传50张图片，本次选择了${t.length}张，已超出限制`)},Rt=()=>{P.value=!0,he(),je()};Et(async()=>{await Ue();try{await he(),await je()}catch(t){console.error("加载模板数据失败:",t)}Wt()});const At=async()=>{if(!b.value||b.value.length===0){d.warning("没有可下载的图片");return}try{const t=a.taskId;if(!t){d.warning("无法获取任务ID，请刷新页面重试");return}ve.value=!0;const e=`/api/ai/download-task/${t}`,o=document.createElement("a");o.href=e,o.target="_blank",o.download=`${a.taskName||"图片集"}.zip`,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>{ve.value=!1,d.success("打包下载完成")},3e3)}catch(t){console.error("下载失败:",t),d.error("下载失败: "+(t.message||"未知错误")),ve.value=!1}},Qe=h([{label:"加载中...",value:"default"}]),Wt=async()=>{try{const t=await $e.get(`${G}/fonts`);t.data.success?(Qe.value=t.data.data.map(e=>({label:e.name,value:e.value,url:e.path?`/${e.path}`:null,cssFamily:e.css_family})),qt()):console.error("获取字体列表失败:",t.data.error)}catch(t){console.error("获取字体列表失败:",t),Qe.value=[{label:"默认字体",value:"default"},{label:"黑体",value:"heiti"},{label:"宋体",value:"songti"},{label:"微软雅黑",value:"msyh"},{label:"楷体",value:"kaiti"}]}},qt=()=>{document.querySelectorAll('style[data-font-loader="true"]').forEach(e=>e.remove());const t=Qe.value.filter(e=>e.url);if(t.length>0){const e=document.createElement("style");e.setAttribute("data-font-loader","true");let o="";t.forEach(u=>{o+=`
        @font-face {
          font-family: '${u.value}';
          src: url('${u.url}') format('${zt(u.url)}');
          font-weight: normal;
          font-style: normal;
        }
      `}),e.textContent=o,document.head.appendChild(e)}},zt=t=>t.endsWith(".ttf")?"truetype":t.endsWith(".otf")?"opentype":t.endsWith(".woff")?"woff":t.endsWith(".woff2")?"woff2":"truetype",He=h(!1),Ze=h(""),et=h(""),tt=h({}),Pt=()=>{Ze.value=a.taskId,et.value=a.taskName;const t=a.templateIds||[],e=a.selectedTemplateNames||[];tt.value=e.length>0?`${e.join(", ")}(ID: ${t.join(", ")})`:"未使用模板",He.value=!0},jt=()=>{},Fe=h(!1),se=h(0),ue=h(null),Ve=t=>{if(!t||!t.imageUrl)return!1;if(t.width&&t.height)return t.width/t.height<.8;if(typeof t.imageUrl=="string"){const e=t.imageUrl.match(/(\d+)x(\d+)/);if(e&&e.length===3){const o=parseInt(e[1]),u=parseInt(e[2]);if(!isNaN(o)&&!isNaN(u)&&o>0&&u>0)return o/u<.8}}return setTimeout(()=>{document.querySelectorAll(".preview-image").forEach(o=>{if(o.src===t.imageUrl&&o.complete&&o.naturalWidth&&o.naturalHeight&&o.naturalWidth/o.naturalHeight<.8){const n=o.closest(".preview-image-wrapper");n&&!n.classList.contains("tall-image")&&n.classList.add("tall-image")}})},100),!1},De=t=>{if(Fe.value)switch(t.key){case"ArrowLeft":vt();break;case"ArrowRight":gt();break;case"Escape":at();break}},vt=()=>{se.value>0&&(se.value--,ue.value=b.value[se.value],Ke(()=>{const t=document.querySelector(".full-image-container");t&&Ve(ue.value)?t.classList.add("tall-image"):t&&t.classList.remove("tall-image")}))},gt=()=>{b.value&&se.value<b.value.length-1&&(se.value++,ue.value=b.value[se.value],Ke(()=>{const t=document.querySelector(".full-image-container");t&&Ve(ue.value)?t.classList.add("tall-image"):t&&t.classList.remove("tall-image")}))},Mt=t=>{if(!(!t||!t.imageUrl))try{const e=document.createElement("a");e.href=t.imageUrl,e.download=t.name||`AI生成图片_${new Date().getTime()}.png`,document.body.appendChild(e),e.click(),document.body.removeChild(e),d.success("图片下载中...")}catch(e){console.error("下载图片失败:",e),d.error("下载图片失败")}},at=()=>{Fe.value=!1,document.body.classList.remove("no-scroll"),document.removeEventListener("keydown",De)};ct(()=>{document.removeEventListener("keydown",De)});const Ot=()=>{try{const t=new Date().getTime(),e=`${G}/download-template?_t=${t}`,o=document.createElement("a");o.href=e,o.target="_blank",o.download="生成图片模板.xlsx",document.body.appendChild(o),o.click(),document.body.removeChild(o),d.success("模板下载中...")}catch(t){console.error("下载模板失败:",t),d.error("下载模板失败: "+(t.message||"未知错误"))}},Bt=async(t,e)=>{var o,u;if(!t.regenerating)try{b.value[e]={...t,regenerating:!0};const n={task_id:a.taskId,image_index:e,template_id:t.template_id||(a.templateIds.length>0?a.templateIds[e%a.templateIds.length]:null)};j.value&&j.value.length>0&&j.value[e]&&(n.prompt=j.value[e].prompt,n.text1=j.value[e].text1,n.text2=j.value[e].text2);const p=await $e.post(`${G}/regenerate_image`,n);if(p.data.success){const r={...t,regenerating:!1,imageUrl:p.data.imageUrl||p.data.image_path||(p.data.results&&p.data.results.length>0?p.data.results[0].imageUrl||p.data.results[0].image_path:null),name:f(t,t.index!==void 0?t.index:e),time:new Date().getTime()};b.value.splice(e,1,r),d.success("图片重新生成成功")}else b.value[e]={...t,regenerating:!1},d.error(`重新生成失败: ${p.data.error||"未知错误"}`)}catch(n){console.error("重新生成图片失败:",n),b.value[e]={...t,regenerating:!1},d.error(`重新生成图片失败: ${((u=(o=n.response)==null?void 0:o.data)==null?void 0:u.error)||n.message||"未知错误"}`)}},lt=t=>{if(!t)return kt;if(t.startsWith("http://")||t.startsWith("https://"))return t;if(t.startsWith("/file/")||t.startsWith("file/")){const e=t.startsWith("/")?t:`/${t}`;return`${Ne}${e}`}return t.startsWith("/ai/")?t:t.startsWith("/")?`${G}${t}`:`${G}/${t}`},be=t=>{if(!t||typeof t!="string")return"";const e=document.createElement("div");return e.innerHTML=t,(e.textContent||e.innerText||"").trim().replace(/\s+/g," ")},ve=h(!1),Ht=Ee(()=>ve.value?"正在打包...":"一键打包下载"),D=h(!1),Le=h(0),Xt=h(0),J=h(0);Ee(()=>D.value?"正在排队等待处理...":J.value>0?`正在生成中: ${J.value}%`:"正在努力处理中，请稍候...");const st=[{label:"1:1",value:"512x512",orientation:"方形"},{label:"4:3",value:"512x384",orientation:"横版"},{label:"3:4",value:"384x512",orientation:"竖版"},{label:"3:2",value:"512x341",orientation:"横版"},{label:"2:3",value:"341x512",orientation:"竖版"},{label:"16:9",value:"512x288",orientation:"横版"},{label:"9:16",value:"288x512",orientation:"竖版"}],ot=h(null),nt=h(null),Xe=h(!1),we=h([]),ge=h(""),Kt=()=>{Xe.value=!0},Jt=t=>{we.value=t,a.searchImageUrls=t.map(e=>e.url),t.length>0&&d.success(`已选择 ${t.length} 张搜索底图`),Xe.value=!1};return(t,e)=>{var B;const o=Qt,u=Zt,n=wt,p=dt,r=mt,g=ea,S=la,I=ta,Y=aa,oe=It,ne=xt,Re=pt,Ie=St;return v(),_("div",La,[e[48]||(e[48]=l("div",{class:"task-header"},[l("h2")],-1)),l("div",Ra,[l("div",Aa,[l("div",Wa,[l("div",qa,[l("div",za,[l("div",Pa,[e[21]||(e[21]=l("span",{class:"card-title"},"参数配置",-1)),l("div",ja,[s(u,{modelValue:a.panelMode,"onUpdate:modelValue":e[0]||(e[0]=c=>a.panelMode=c),size:"small",class:"panel-switch-group"},{default:i(()=>[s(o,{label:"single"},{default:i(()=>e[19]||(e[19]=[U("单图模式")])),_:1,__:[19]}),s(o,{label:"mosaic",disabled:!0},{default:i(()=>e[20]||(e[20]=[U("拼图模式")])),_:1,__:[20]})]),_:1},8,["modelValue"])])]),l("div",Ma,[l("div",Oa,[e[22]||(e[22]=l("div",{class:"section-header"},[l("span",null,[U("任务名称"),l("span",{class:"required-mark"},"*")])],-1)),l("div",Ba,[s(p,{modelValue:a.taskName,"onUpdate:modelValue":e[1]||(e[1]=c=>a.taskName=c),placeholder:"请输入任务名称",clearable:""},{prefix:i(()=>[s(n,null,{default:i(()=>[s($(ht))]),_:1})]),_:1},8,["modelValue"])])]),l("div",Ha,[l("div",Xa,[e[23]||(e[23]=l("span",null,"模板",-1)),a.selectedTemplateNames.length>0?(v(),_("span",Ka," 已选择 "+E(a.selectedTemplateNames.length)+" 个模板 ",1)):F("",!0)]),l("div",Ja,[l("div",{class:"watermark-uploader",onClick:Rt},[l("div",Ya,[a.selectedTemplateNames.length?(v(),_("span",Ga,E(a.selectedTemplateNames.join(", ")),1)):(v(),_("div",Qa,[s(n,{class:"upload-icon"},{default:i(()=>[s($(_t))]),_:1}),e[24]||(e[24]=l("span",null,"选择模板",-1))]))])]),s(r,{class:"upload-action-btn",onClick:e[2]||(e[2]=c=>y.value=!0)},{default:i(()=>[s(n,null,{default:i(()=>[s($(rt))]),_:1})]),_:1})])]),a.imageSourceType==="ai"&&a.templateIds.length===0?(v(),_("div",Za,[e[27]||(e[27]=l("div",{class:"section-header"},[l("span",null,[U("底图尺寸"),l("span",{class:"required-mark"},"*")])],-1)),l("div",el,[s(I,{modelValue:a.imageSize,"onUpdate:modelValue":e[3]||(e[3]=c=>a.imageSize=c),placeholder:"请选择AI底图尺寸",class:"w-100"},{default:i(()=>[(v(!0),_(te,null,me(st.filter(c=>c.orientation==="方形"),c=>(v(),Z(g,{key:c.value,label:`${c.label} (${c.orientation})`,value:c.value},null,8,["label","value"]))),128)),s(S,{"content-position":"center"},{default:i(()=>e[25]||(e[25]=[U("横版")])),_:1,__:[25]}),(v(!0),_(te,null,me(st.filter(c=>c.orientation==="横版"),c=>(v(),Z(g,{key:c.value,label:`${c.label} (${c.orientation})`,value:c.value},null,8,["label","value"]))),128)),s(S,{"content-position":"center"},{default:i(()=>e[26]||(e[26]=[U("竖版")])),_:1,__:[26]}),(v(!0),_(te,null,me(st.filter(c=>c.orientation==="竖版"),c=>(v(),Z(g,{key:c.value,label:`${c.label} (${c.orientation})`,value:c.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])):F("",!0),l("div",tl,[e[33]||(e[33]=l("div",{class:"section-header"},[l("span",null,[U("底图配置"),l("span",{class:"required-mark"},"*")])],-1)),l("div",al,[l("div",ll,[l("div",{class:Q(["option-indicator",{"at-custom":a.imageSourceType==="custom","at-search":a.imageSourceType==="search"}])},null,2),l("div",{class:Q(["option-item",{active:a.imageSourceType==="ai"}]),onClick:e[4]||(e[4]=c=>a.imageSourceType="ai")}," AI底图 ",2),l("div",{class:Q(["option-item",{active:a.imageSourceType==="custom"}]),onClick:e[5]||(e[5]=c=>a.imageSourceType="custom")}," 自定义底图 ",2),l("div",{class:Q(["option-item",{active:a.imageSourceType==="search"}]),onClick:e[6]||(e[6]=c=>a.imageSourceType="search")}," 搜索底图 ",2)])]),a.imageSourceType==="ai"?(v(),_("div",sl,[l("div",ol,[s(Y,{ref_key:"excelUploadRef",ref:ot,action:"#","auto-upload":!1,"on-change":ye,"on-remove":_e,accept:".xlsx,.xls",drag:"",class:"upload-drag-area","file-list":L.value,"show-file-list":!1},{default:i(()=>[k.value===0?(v(),_(te,{key:0},[s(n,{class:"upload-icon"},{default:i(()=>[s($(rt))]),_:1}),e[28]||(e[28]=l("div",{class:"upload-text"},"上传/拖动Excel文件到此处",-1))],64)):(v(),_("div",nl,[s(n,{class:"success-icon"},{default:i(()=>[s($(Je))]),_:1}),l("div",rl,"已解析 "+E(k.value)+" 条数据，将生成 "+E(k.value)+" 张图片",1),s(r,{type:"text",size:"small",class:"remove-file-btn",onClick:ee(_e,["stop"])},{default:i(()=>[s(n,null,{default:i(()=>[s($(We))]),_:1})]),_:1})]))]),_:1},8,["file-list"]),l("div",il,[s(r,{type:"primary",size:"small",class:"download-template-btn",link:"",onClick:Ot},{default:i(()=>[s(n,null,{default:i(()=>[s($(it))]),_:1}),e[29]||(e[29]=U(" 下载模板 "))]),_:1,__:[29]})])])])):a.imageSourceType==="custom"?(v(),_("div",cl,[l("div",ul,[s(Y,{ref_key:"imageUploadRef",ref:nt,action:"#","auto-upload":!1,"on-change":Ft,"on-remove":Vt,"on-exceed":Lt,accept:"image/*",multiple:!0,limit:50,drag:"",class:"upload-drag-area","file-list":w.value,"show-file-list":!1},{default:i(()=>[H.value===0?(v(),_(te,{key:0},[s(n,{class:"upload-icon"},{default:i(()=>[s($(rt))]),_:1}),e[30]||(e[30]=l("div",{class:"upload-text"},"上传/拖动图片到此处",-1))],64)):(v(),_("div",dl,[s(n,{class:"success-icon"},{default:i(()=>[s($(Je))]),_:1}),l("div",ml,"已上传 "+E(H.value)+" 张图片",1),s(r,{type:"text",size:"small",class:"remove-file-btn",onClick:ee(Dt,["stop"])},{default:i(()=>[s(n,null,{default:i(()=>[s($(We))]),_:1})]),_:1})]))]),_:1},8,["file-list"])])])):a.imageSourceType==="search"?(v(),_("div",pl,[l("div",{class:"search-area",onClick:Kt,style:{height:"100px"}},[l("div",vl,[s(n,{class:"search-icon"},{default:i(()=>[s($(Ye))]),_:1}),e[31]||(e[31]=l("div",{class:"search-text"},"点击此处搜索互联网底图",-1)),we.value.length>0?(v(),_("div",gl," 已选择 "+E(we.value.length)+" 张底图 ",1)):F("",!0)])]),we.value.length>0?(v(),_("div",fl,[e[32]||(e[32]=l("div",{class:"section-header",style:{"margin-top":"15px"}},[l("span",null,[U("文案"),l("span",{class:"required-mark"},"*")])],-1)),s(p,{modelValue:ge.value,"onUpdate:modelValue":e[7]||(e[7]=c=>ge.value=c),type:"textarea",rows:1,placeholder:"请输入文案（所有搜索底图将使用相同文案）",style:{"margin-bottom":"5px"}},null,8,["modelValue"])])):F("",!0)])):F("",!0)]),l("div",hl,[e[35]||(e[35]=l("div",{class:"section-header"},[l("span",null,"图片命名规则")],-1)),l("div",_l,[l("div",kl,[s(p,{modelValue:a.customImageName,"onUpdate:modelValue":e[8]||(e[8]=c=>a.customImageName=c),placeholder:"请输入自定义命名规则",clearable:""},{prefix:i(()=>[s(n,null,{default:i(()=>[s($(ht))]),_:1})]),_:1},8,["modelValue"]),l("div",yl,[e[34]||(e[34]=l("span",{class:"variables-title"},"可用变量：",-1)),l("div",bl,[(v(!0),_(te,null,me(X.value,c=>(v(),Z(oe,{key:c.value,size:"small",class:"variable-tag",onClick:re=>V(c.value)},{default:i(()=>[U(E(c.label),1)]),_:2},1032,["onClick"]))),128))])]),l("div",wl,[s(oe,{size:"small",type:"info"},{default:i(()=>[U("预览: "+E(Be()),1)]),_:1})])])])]),l("div",Il,[l("button",{class:"create-task-btn",onClick:m,disabled:N.value},[l("span",Sl,[s(n,null,{default:i(()=>[s($(_t))]),_:1})]),l("span",$l,E(N.value?"创建中...":"创建任务"),1)],8,xl),l("button",{class:"reset-btn",onClick:ce},e[36]||(e[36]=[l("span",{class:"btn-text"},"重置",-1)]))])])])])])]),l("div",El,[l("div",Nl,[e[38]||(e[38]=l("span",{class:"preview-title"},"结果区域",-1)),l("div",Tl,[b.value.length>0?(v(),Z(r,{key:0,type:"warning",size:"default",class:"feedback-btn",onClick:e[9]||(e[9]=c=>Pt())},{default:i(()=>[s(n,null,{default:i(()=>[s($(Tt))]),_:1}),e[37]||(e[37]=U(" 效果不理想？点此反馈 "))]),_:1,__:[37]})):F("",!0),b.value.length>0?(v(),Z(r,{key:1,type:"primary",size:"default",class:"download-all-btn",loading:ve.value,disabled:ve.value,onClick:At},{default:i(()=>[s(n,null,{default:i(()=>[s($(it))]),_:1}),U(" "+E(Ht.value),1)]),_:1},8,["loading","disabled"])):F("",!0)])]),l("div",Cl,[l("div",Ul,[b.value.length>0?(v(),_("div",Fl,[(v(!0),_(te,null,me(b.value,(c,re)=>(v(),_("div",{key:re,class:"result-item"},[l("div",Vl,[l("div",{class:Q(["preview-image-wrapper",{"tall-image":Ve(c)}])},[l("img",{src:lt(c.imageUrl),alt:"生成结果",class:"preview-image",onClick:fe=>q(c,re)},null,8,Dl),a.imageSourceType==="ai"?(v(),_("div",{key:0,class:Q(["regenerate-btn",{loading:c.regenerating}]),onClick:ee(fe=>Bt(c,re),["stop"]),title:"重新生成此图片"},[c.regenerating?(v(),_("div",Rl)):(v(),Z(n,{key:0},{default:i(()=>[s($(oa))]),_:1})),e[39]||(e[39]=l("span",{class:"regenerate-tooltip"},"重新生成",-1))],10,Ll)):F("",!0),c.regenerating?(v(),_("div",Al,e[40]||(e[40]=[l("div",{class:"regenerating-spinner"},null,-1),l("div",{class:"regenerating-text"},"重新生成中...",-1)]))):F("",!0)],2)]),l("div",Wl,[l("span",ql,E(c.name),1),l("span",zl,E(Me(c.time)),1)])]))),128))])):F("",!0),x.value?(v(),_("div",{key:1,class:Q(["loading-result",{"with-results":b.value.length>0}])},[l("div",Pl,[e[41]||(e[41]=l("div",{class:"lottie-container"},[l("lottie-player",{src:"/lottie-animation.json",background:"transparent",speed:"1",style:{width:"400px !important",height:"400px !important","max-width":"100% !important"},loop:"",autoplay:""})],-1)),l("div",jl,E(D.value?"排队中，请稍候...":J.value>0?"正在生成图片...":"正在处理你的请求..."),1),J.value>0?(v(),_("div",Ml,[l("div",{class:"progress-bar",style:na({width:J.value?`${J.value}%`:"0%"})},null,4),J.value>0?(v(),_("div",Ol,E(J.value)+"%",1)):F("",!0)])):F("",!0),b.value.length>0?(v(),_("div",Bl," 已生成 "+E(b.value.length)+" 张图片 ",1)):F("",!0),D.value?(v(),_("div",Hl," 当前队列位置: "+E(Le.value),1)):F("",!0)])],2)):b.value.length?F("",!0):(v(),_("div",Xl,[s(n,null,{default:i(()=>[s($(ra))]),_:1}),e[42]||(e[42]=l("span",null,"任务完成后，生成的图片将在此处显示",-1))]))])])])]),s(Re,{modelValue:P.value,"onUpdate:modelValue":e[13]||(e[13]=c=>P.value=c),title:"选择模板",width:"85%",class:"template-library-dialog",top:"5vh"},{footer:i(()=>[l("span",ps,[s(r,{onClick:e[12]||(e[12]=c=>P.value=!1)},{default:i(()=>e[46]||(e[46]=[U("取消")])),_:1,__:[46]}),s(r,{type:"primary",onClick:Ce},{default:i(()=>e[47]||(e[47]=[U("确定")])),_:1,__:[47]})])]),default:i(()=>[l("div",Kl,[l("div",Jl,[l("div",Yl,[e[45]||(e[45]=l("div",{class:"my-tags-header"},[l("h3",null,"模板分类")],-1)),l("div",Gl,[l("div",{class:Q(["tag-item all-tag",{active:K.value==="all"}]),onClick:e[10]||(e[10]=c=>ze("all"))},e[43]||(e[43]=[l("span",{class:"tag-icon"},null,-1),l("span",{class:"tag-name"},"全部模板",-1)]),2),(v(!0),_(te,null,me(T.value,(c,re)=>(v(),_("div",{key:re,class:Q(["tag-item",{active:K.value===c.value}]),onClick:fe=>ze(c.value)},[e[44]||(e[44]=l("span",{class:"tag-icon"},null,-1)),l("span",Zl,E(c.label),1)],10,Ql))),128))])]),l("div",es,[l("div",ts,[l("div",as,[s(p,{modelValue:M.value,"onUpdate:modelValue":e[11]||(e[11]=c=>M.value=c),placeholder:"搜索模板...",clearable:"",onClear:Pe,onInput:Pe},{prefix:i(()=>[s(n,null,{default:i(()=>[s($(Ye))]),_:1})]),_:1},8,["modelValue"])]),l("div",ls,[s(r,{type:"primary",size:"small",onClick:Oe,disabled:O.value.length===0},{default:i(()=>[U(E(pe.value?"取消全选":"全选"),1)]),_:1},8,["disabled"]),a.templateIds.length>0?(v(),Z(oe,{key:0,type:"info",effect:"plain"},{default:i(()=>[U(" 已选择: "+E(a.templateIds.length)+"个 ",1)]),_:1})):F("",!0)])]),Nt((v(),_("div",ss,[l("div",os,[(v(!0),_(te,null,me(O.value,(c,re)=>(v(),_("div",{key:re,class:Q(["template-item",{active:a.templateIds.includes(c.id)}]),onClick:fe=>ke(c)},[l("div",rs,[l("img",{src:lt(c.previewImage),alt:"模板预览",class:"template-image"},null,8,is),a.templateIds.includes(c.id)?(v(),_("div",cs,[s(n,null,{default:i(()=>[s($(Je))]),_:1})])):F("",!0)]),l("div",us,[l("div",ds,E(c.name),1)])],10,ns))),128))]),O.value.length===0?(v(),_("div",ms,[s(ne,{description:"暂无模板"})])):F("",!0)])),[[Ie,ie.value]])])])])]),_:1},8,["modelValue"]),s(Re,{modelValue:y.value,"onUpdate:modelValue":e[15]||(e[15]=c=>y.value=c),title:"添加模板",width:"80%","before-close":()=>y.value=!1,class:"template-form-dialog",top:"1vh"},{default:i(()=>[s(ia,{"template-tags":T.value,onSuccess:Te,onCancel:e[14]||(e[14]=c=>y.value=!1)},null,8,["template-tags"])]),_:1},8,["modelValue","before-close"]),s(pa,{visible:He.value,"onUpdate:visible":e[16]||(e[16]=c=>He.value=c),"task-id":Ze.value,"task-name":et.value,"template-info":tt.value,onSuccess:jt},null,8,["visible","task-id","task-name","template-info"]),Fe.value?(v(),_("div",{key:0,class:"full-image-preview",onClick:at},[l("div",{class:Q(["full-image-container",{"tall-image":Ve(ue.value)}])},[l("img",{src:lt((B=ue.value)==null?void 0:B.imageUrl),alt:"全屏预览",class:"full-preview-image"},null,8,vs),l("div",gs,E(se.value+1)+"/"+E(b.value.length),1),l("button",{class:"full-preview-close",onClick:ee(at,["stop"])},[s(n,null,{default:i(()=>[s($(We))]),_:1})]),l("div",fs,[s(r,{circle:"",onClick:ee(vt,["stop"]),disabled:se.value===0},{default:i(()=>[s(n,null,{default:i(()=>[s($(Ct))]),_:1})]),_:1},8,["disabled"]),s(r,{circle:"",onClick:ee(gt,["stop"]),disabled:se.value>=b.value.length-1},{default:i(()=>[s(n,null,{default:i(()=>[s($(Ut))]),_:1})]),_:1},8,["disabled"])]),s(r,{class:"full-preview-download",circle:"",onClick:e[17]||(e[17]=ee(c=>Mt(ue.value),["stop"])),icon:"Download"},{default:i(()=>[s(n,null,{default:i(()=>[s($(it))]),_:1})]),_:1})],2)])):F("",!0),s(Da,{visible:Xe.value,"onUpdate:visible":e[18]||(e[18]=c=>Xe.value=c),"selected-images":we.value,onSelect:Jt},null,8,["visible","selected-images"])])}}},Ds=ut(hs,[["__scopeId","data-v-1b70ca0a"]]);export{Ds as default};
//# sourceMappingURL=CreateTask-i16GFIKO.js.map
