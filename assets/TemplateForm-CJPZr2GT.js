import{_ as Ae,e as Ie,f as Te,a as We,i as ze,j as He,k as Pe,b as Be,d as Oe,E as p}from"./index-reG5_0Rm.js";import{E as je}from"./el-row-BDVi6QVL.js";import{E as Ye}from"./el-col-CuQjGcsV.js";import{E as qe}from"./el-color-picker-Dn2TPk05.js";import{E as Ne}from"./el-switch-BXUew4Q-.js";import{E as Xe}from"./el-divider-P24W8btS.js";import{E as Ge}from"./el-progress-C2HcI4BS.js";import{r as y,a4 as Je,A as be,z as Ke,a0 as Qe,q as U,s as x,S as u,N as v,Q as f,ah as $,M as T,aM as z,P as H,u as X,aH as Ze,L as G,Y as we,X as le,bv as ye,ba as et}from"./vue-vendor-BgjGt3mC.js";import{a as P}from"./axios-xsH4HHeE.js";const tt={class:"form-card"},at={class:"add-tag-btn"},lt={class:"form-card mt-20"},ot={class:"text-area-group rounded-box"},nt={class:"text-area-header"},st={key:0,class:"text-settings"},rt={class:"font-select-container"},it={class:"font-option-item"},ut={class:"color-picker-group"},dt={class:"color-picker-group"},ft={class:"text-area-group rounded-box"},ct={class:"text-area-header"},mt={key:0,class:"text-settings"},vt={class:"font-select-container"},pt={class:"font-option-item"},ht={class:"color-picker-group"},gt={class:"color-picker-group"},xt={class:"preview-card"},bt={class:"preview-container"},wt={key:1,class:"empty-preview"},yt={key:0,class:"preview-tips"},_t={class:"dialog-footer"},Ft={key:0,class:"selected-font-file"},kt={class:"drag-hint"},Ct={class:"dialog-footer"},Ut={class:"dialog-footer"},S="/api/ai",oe="/api",$t={__name:"TemplateForm",props:{templateTags:{type:Array,default:()=>[{label:"京东模板",value:"jd"},{label:"百度模板",value:"baidu"},{label:"小说模板",value:"novel"},{label:"夸克模板",value:"quark"}]},templateData:{type:Object,default:null},isEditMode:{type:Boolean,default:!1}},emits:["cancel","success","add-tag"],setup(_e,{emit:Fe}){const c=_e,ne=Fe,ke="/api/",se=y(null),h=y(""),_=y(null),j=y(null),C=y(null),B=y(!1),M=y(""),E=y([]),J=y(!1),R=y(null),Y=y({x:0,y:0}),L=y(""),A=y(""),I=y({name:""}),O=y(!1),k=y({name:"",file:null,textArea:null}),K=[{label:"1:1",value:"512x512",orientation:"方形"},{label:"4:3",value:"512x384",orientation:"横版"},{label:"3:4",value:"384x512",orientation:"竖版"},{label:"3:2",value:"512x341",orientation:"横版"},{label:"2:3",value:"341x512",orientation:"竖版"},{label:"16:9",value:"512x288",orientation:"横版"},{label:"9:16",value:"288x512",orientation:"竖版"}],b=y([{label:"正在加载字体列表...",value:""}]),a=Je({name:"",tag:"",image:null,imageSize:"",serverImageUrl:"",text1:{enabled:!1,font:"",x:10,y:10,width:30,height:15,color:"#FFFFFF",strokeColor:null},text2:{enabled:!1,font:"",x:10,y:60,width:30,height:15,color:"#FFFFFF",strokeColor:null}}),Ce={name:[{required:!0,message:"请输入模板名称",trigger:"blur"}],image:[{required:!0,validator:(e,t,l)=>{c.isEditMode&&(a.serverImageUrl||h.value)||a.image?l():l(new Error("请上传模板图片"))},trigger:"change"}],imageSize:[{required:!0,message:"请选择AI底图尺寸",trigger:"change"}]},re=e=>{if(!e)return"";if(e&&e.startsWith("/file/"))return`${ke}${e}`;if(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("blob:"))return e;if(e.startsWith("/api/ai/"))return e.replace("/api/ai/","/api/");if(e.startsWith("/ai/"))return`${oe}${e.substring(3)}`;let t;return e.startsWith("/")?t=`${oe}${e}`:t=`${oe}/${e}`,t};be(h,e=>{e&&Q(e)}),be([()=>a.text1.enabled,()=>a.text1.font,()=>a.text1.color,()=>a.text1.strokeColor,()=>a.text2.enabled,()=>a.text2.font,()=>a.text2.color,()=>a.text2.strokeColor],()=>{h.value&&w()},{deep:!0});const Q=e=>{if(!e){console.warn("尝试加载空URL");return}C.value=new Image;const t=re(e);C.value.src=t,C.value.onerror=l=>{console.error("图片加载失败:",l),p.warning("图片加载失败，请重试")},C.value.onload=()=>{Ue(),w()}},Ue=()=>{if(!_.value){console.warn("画布元素不存在");return}if(!C.value){console.warn("预览图像不存在");return}const e=_.value.closest(".preview-container");if(!e){console.warn("找不到预览容器");return}const t=e.clientWidth,l=e.clientHeight;if(t<=0||l<=0){console.warn("容器尺寸无效:",t,l);return}if(C.value.width<=0||C.value.height<=0){console.warn("图像尺寸无效:",C.value.width,C.value.height);return}const n=C.value.width/C.value.height,d=t/l;let o,i;if(n>d?(o=t-20,i=o/n):(i=l-20,o=i*n),o=Math.max(1,Math.round(o)),i=Math.max(1,Math.round(i)),_.value.width=o,_.value.height=i,j.value=_.value.getContext("2d"),!j.value){console.error("无法获取canvas 2D上下文");return}},w=()=>{if(!j.value||!_.value){console.warn("无法重绘：上下文或画布不存在");return}if(!C.value){console.warn("无法重绘：预览图像不存在");return}try{const e=_.value,t=j.value;t.clearRect(0,0,e.width,e.height),t.drawImage(C.value,0,0,e.width,e.height),a.text1.enabled&&ie(t,"文字1区域",a.text1,R.value==="text1"),a.text2.enabled&&ie(t,"文字2区域",a.text2,R.value==="text2")}catch(e){console.error("画布重绘失败:",e),p.error("预览渲染失败，请重试")}},ie=(e,t,l,n)=>{const d=_.value,o=l.x*d.width/100,i=l.y*d.height/100,r=l.width*d.width/100,m=l.height*d.height/100;e.fillStyle=n?"rgba(64, 158, 255, 0.4)":"rgba(0, 0, 0, 0.4)",e.fillRect(o,i,r,m),e.strokeStyle=n?"#409eff":"rgba(255, 255, 255, 0.7)",e.lineWidth=n?2:1,e.strokeRect(o,i,r,m);const g=`'${l.font}', "微软雅黑", "Microsoft YaHei", Arial, sans-serif`,W=b.value.find(F=>F.value===l.font);W!=null&&W.label||l.font;const V=t==="文字1区域"?"预览文字1":"预览文字2";e.save();try{e.textAlign="center",e.textBaseline="middle";const F=Math.min(Math.floor(r/5),Math.floor(m/2),20);e.font=`bold ${F}px ${g}`,l.strokeColor&&(e.strokeStyle=l.strokeColor,e.lineWidth=3,e.strokeText(V,o+r/2,i+m/2)),e.fillStyle=l.color||"white",e.fillText(V,o+r/2,i+m/2)}catch(F){console.warn("绘制文本区域时出现错误:",F),e.font="bold 16px Arial, sans-serif",e.textAlign="center",e.textBaseline="middle",l.strokeColor&&(e.strokeStyle=l.strokeColor,e.lineWidth=3,e.strokeText(V,o+r/2,i+m/2)),e.fillStyle=l.color||"white",e.fillText(V,o+r/2,i+m/2)}e.restore(),n&&[{id:"tl",x:o,y:i},{id:"tr",x:o+r,y:i},{id:"bl",x:o,y:i+m},{id:"br",x:o+r,y:i+m}].forEach(D=>{e.fillStyle="#409eff",e.fillRect(D.x-4,D.y-4,8,8),e.strokeStyle="white",e.lineWidth=1,e.strokeRect(D.x-4,D.y-4,8,8)})},ue=e=>{if(!e)return'"微软雅黑", "Microsoft YaHei", Arial, sans-serif';const t=b.value.find(l=>l.value===e);if(t){if(t.url)return`'${e}', "微软雅黑", "Microsoft YaHei", Arial, sans-serif`;if(t.cssFamily)return t.cssFamily}switch(e){case"heiti":return'"黑体", "SimHei", sans-serif';case"songti":return'"宋体", "SimSun", serif';case"msyh":return'"微软雅黑", "Microsoft YaHei", sans-serif';case"kaiti":return'"楷体", "KaiTi", serif';default:return'"微软雅黑", "Microsoft YaHei", Arial, sans-serif'}},de=(e,t,l,n)=>{const d=l.x*n.width/100,o=l.y*n.height/100,i=l.width*n.width/100,r=l.height*n.height/100;return e>=d&&e<=d+i&&t>=o&&t<=o+r},fe=(e,t,l,n)=>{const d=l.x*n.width/100,o=l.y*n.height/100,i=l.width*n.width/100,r=l.height*n.height/100,m=8;return Math.abs(e-d)<=m&&Math.abs(t-o)<=m?"tl":Math.abs(e-(d+i))<=m&&Math.abs(t-o)<=m?"tr":Math.abs(e-d)<=m&&Math.abs(t-(o+r))<=m?"bl":Math.abs(e-(d+i))<=m&&Math.abs(t-(o+r))<=m?"br":""},$e=e=>{const t=_.value;if(!t)return;const l=t.getBoundingClientRect(),n=e.clientX-l.left,d=e.clientY-l.top;Y.value={x:n,y:d};let o=!1;if(a.text2.enabled){const i=fe(n,d,a.text2,t);i?(R.value="text2",L.value="resize",A.value=i,o=!0):de(n,d,a.text2,t)&&(R.value="text2",L.value="move",o=!0)}if(!o&&a.text1.enabled){const i=fe(n,d,a.text1,t);i?(R.value="text1",L.value="resize",A.value=i,o=!0):de(n,d,a.text1,t)&&(R.value="text1",L.value="move",o=!0)}o&&(J.value=!0,document.addEventListener("mousemove",Z),document.addEventListener("mouseup",ee),w())},Z=e=>{if(!J.value||!R.value)return;const t=_.value,l=t.getBoundingClientRect(),n=e.clientX-l.left,d=e.clientY-l.top,o=(n-Y.value.x)/t.width*100,i=(d-Y.value.y)/t.height*100,r=R.value==="text1"?a.text1:a.text2;if(L.value==="move")r.x=Math.max(0,Math.min(100-r.width,r.x+o)),r.y=Math.max(0,Math.min(100-r.height,r.y+i));else if(L.value==="resize"){if(A.value==="tl"){const m=r.width-o,g=r.height-i;m>=5&&(r.x+=o,r.width=m),g>=5&&(r.y+=i,r.height=g)}else if(A.value==="tr"){const m=r.width+o,g=r.height-i;m>=5&&(r.width=m),g>=5&&(r.y+=i,r.height=g)}else if(A.value==="bl"){const m=r.width-o,g=r.height+i;m>=5&&(r.x+=o,r.width=m),g>=5&&(r.height=g)}else if(A.value==="br"){const m=r.width+o,g=r.height+i;m>=5&&(r.width=m),g>=5&&(r.height=g)}r.width=Math.min(100,Math.max(5,r.width)),r.height=Math.min(100,Math.max(5,r.height)),r.x=Math.min(100-r.width,Math.max(0,r.x)),r.y=Math.min(100-r.height,Math.max(0,r.y))}Y.value={x:n,y:d},w()},ee=()=>{J.value=!1,L.value="",A.value="",document.removeEventListener("mousemove",Z),document.removeEventListener("mouseup",ee)},Ee=async e=>{var t,l;a.image=e.raw;try{h.value&&h.value.startsWith("blob:")&&URL.revokeObjectURL(h.value),h.value=URL.createObjectURL(e.raw),setTimeout(()=>{Q(h.value)},50);const n=new FormData;n.append("file",e.raw);const d=await P.post(`${S}/upload-image`,n,{headers:{"Content-Type":"multipart/form-data"}});d.data.success?(a.serverImageUrl=d.data["       "],d.data.imageUrl&&d.data.imageUrl.startsWith("/file/")&&(h.value&&h.value.startsWith("blob:")&&URL.revokeObjectURL(h.value),h.value=d.data.imageUrl,setTimeout(()=>{Q(h.value)},100)),p.success("图片上传成功")):p.error(d.data.error||"图片上传失败")}catch(n){console.error("上传图片失败:",n),p.error("上传图片失败: "+(((l=(t=n.response)==null?void 0:t.data)==null?void 0:l.error)||n.message))}},Me=async()=>{se.value.validate(async e=>{var t,l,n;if(e){const d=((t=E.value.find(i=>i.value===a.tag))==null?void 0:t.label)||"自定义模板",o={name:a.name,tag:d,imageSize:a.imageSize,previewImage:a.serverImageUrl||(c.isEditMode&&c.templateData?c.templateData.previewImage:h.value),description:`${a.name}模板`,config:{watermark:a.serverImageUrl||(c.isEditMode&&c.templateData?c.templateData.previewImage:h.value),position:"bottom-right",showLogo:!0,fontSize:24,color:"#000000",fontFamily:"default",bold:!0,enableStroke:!0,strokeColor:"#ffffff",opacity:1},text1_enabled:a.text1.enabled?1:0,text2_enabled:a.text2.enabled?1:0};if(c.isEditMode&&c.templateData&&c.templateData.config&&(o.config={...c.templateData.config,watermark:a.serverImageUrl||c.templateData.previewImage}),a.text1.enabled){const i=ce(a.text1.font);o.text1={enabled:1,font:i,x:a.text1.x,y:a.text1.y,width:a.text1.width,height:a.text1.height,color:a.text1.color,strokeColor:a.text1.strokeColor}}else o.text1=null;if(a.text2.enabled){const i=ce(a.text2.font);o.text2={enabled:1,font:i,x:a.text2.x,y:a.text2.y,width:a.text2.width,height:a.text2.height,color:a.text2.color,strokeColor:a.text2.strokeColor}}else o.text2=null;try{let i;if(c.isEditMode&&c.templateData&&c.templateData.id?(o.id=c.templateData.id,i=await P.put(`${S}/templates/${c.templateData.id}`,o)):i=await P.post(`${S}/templates`,o),i.data.success){p.success(c.isEditMode?"模板更新成功":"模板添加成功");const r=i.data.template||i.data.data;r&&(r.text1&&a.text1.enabled&&(r.text1.font=r.text1.font||a.text1.font),r.text2&&a.text2.enabled&&(r.text2.font=r.text2.font||a.text2.font),r.text1_enabled=a.text1.enabled?1:0,r.text2_enabled=a.text2.enabled?1:0),ne("success",r),ne("cancel")}else p.error(i.data.error||(c.isEditMode?"更新模板失败":"创建模板失败"))}catch(i){console.error(c.isEditMode?"更新模板失败:":"创建模板失败:",i),p.error((c.isEditMode?"更新模板失败: ":"创建模板失败: ")+(((n=(l=i.response)==null?void 0:l.data)==null?void 0:n.error)||i.message))}}else return p.warning("请填写必填项"),!1})},ce=e=>e?(b.value.length<=1||b.value.some(l=>l.value===e),e):q(),Ve=e=>{const t=e.type==="image/jpeg"||e.type==="image/png",l=e.size/1024/1024<5;return t||p.error("图片只能是JPG或PNG格式!"),l||p.error("图片大小不能超过5MB!"),t&&l},me=(e,t)=>{if(!e||!e.raw){console.warn("无效的文件对象:",e);return}k.value.file=e,k.value.textArea=t,De(e),O.value=!0},De=e=>{if(!(!e||!e.raw)){M.value&&(URL.revokeObjectURL(M.value),M.value="");try{const t=URL.createObjectURL(e.raw);M.value=t;const l=`custom_preview_${Date.now()}`;document.querySelectorAll('style[data-font-preview="true"]').forEach(d=>d.remove());const n=document.createElement("style");n.setAttribute("data-font-preview","true"),n.textContent=`
      @font-face {
        font-family: '${l}';
        src: url('${t}') format('${N(e.raw.name)}');
        font-weight: normal;
        font-style: normal;
        font-display: block;
      }
      .font-preview-custom {
        font-family: '${l}', Arial, sans-serif;
      }
    `,document.head.appendChild(n);try{new FontFace(l,`url(${t})`).load().then(o=>{document.fonts.add(o)}).catch(o=>{console.warn("字体预览加载失败，使用默认样式表方式:",o)})}catch(d){console.warn("FontFace API不可用，使用默认样式表方式:",d)}}catch(t){console.error("字体预览创建失败:",t),p.error("字体预览加载失败，但您仍可以上传字体")}}},Re=async()=>{if(!k.value.name.trim()){p.warning("请输入自定义字体名称");return}if(!k.value.file){p.warning("请选择字体文件");return}try{const e=new FormData,t=k.value.file.raw;e.append("file",t);const l=k.value.name.trim();e.append("name",l);const n=`font_${Date.now()}`;e.append("value",n),e.append("description",`${l} 字体`),e.append("is_default","false");const d=p({message:"正在上传字体，请稍候...",type:"info",duration:0}),o=await P.post(`${S}/fonts/upload`,e,{headers:{"Content-Type":"multipart/form-data"},timeout:6e4});if(d.close(),o.data.success){if(p.success("字体上传成功"),o.data.data&&o.data.data.path){const i={label:o.data.data.name,value:o.data.data.value,url:`${S}/${o.data.data.path}`,cssFamily:o.data.data.css_family||null},r=b.value.findIndex(g=>g.value===i.value);r>=0?b.value[r]=i:b.value.push(i);const m=k.value.textArea;m&&(a[m].font=i.value),he()}else await ve();_.value&&setTimeout(()=>{w()},200),O.value=!1,k.value={name:"",file:null,textArea:null}}else p.error(o.data.error||"字体上传失败")}catch(e){console.error("字体上传失败:",e);let t="字体上传失败";e.response?(console.error("响应状态:",e.response.status),console.error("响应数据:",e.response.data),e.response.data&&e.response.data.detail?t+=`: ${e.response.data.detail}`:e.response.data&&e.response.data.error?t+=`: ${e.response.data.error}`:typeof e.response.data=="string"&&(t+=`: ${e.response.data}`)):e.request?(console.error("请求发送但没有收到响应"),t+="：网络请求超时或服务器无响应"):(console.error("请求设置错误:",e.message),t+=`: ${e.message}`),p.error(t);const l=document.querySelector(".el-message--info");l&&l.remove()}},Se=async()=>{if(!I.value.name.trim()){p.warning("请输入分类名称");return}const e="tag_"+Date.now(),t={label:I.value.name,value:e},l=E.value.some(n=>n.label===t.label);if(E.value.some(n=>n.value===t.value),l){p.warning(`分类名称"${t.label}"已存在`);return}E.value=[...E.value,t],a.tag=e,p.success(`已添加新分类: ${I.value.name}`),I.value.name="",B.value=!1},ve=async()=>{try{const e=await P.get(`${S}/fonts`,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});if(e.data.success){if(!e.data.data||e.data.data.length===0){console.warn("后端返回成功但没有字体数据"),te();return}b.value=e.data.data.map(t=>({label:t.name,value:t.value,url:t.path?`${S}/${t.path}`:null,cssFamily:t.css_family,isDefault:t.is_default||!1})),pe(),he()}else console.error("获取字体列表失败:",e.data.error),p.warning("获取字体列表失败，将使用系统字体"),te()}catch(e){console.error("获取字体列表失败:",e),p.warning("获取字体列表失败，将使用系统字体"),te()}},te=()=>{b.value=[{label:"默认字体",value:"default",isDefault:!0},{label:"黑体",value:"heiti"},{label:"宋体",value:"songti"},{label:"微软雅黑",value:"msyh"},{label:"楷体",value:"kaiti"}],pe()},pe=()=>{const e=q();a.text1&&!a.text1.font&&(a.text1.font=e),a.text2&&!a.text2.font&&(a.text2.font=e)},q=()=>{const e=b.value.find(l=>l.isDefault);if(e)return e.value;const t=["default","msyh","heiti","songti","kaiti"];for(const l of t)if(b.value.some(n=>n.value===l))return l;return b.value.length>0?b.value[0].value:"default"},he=async()=>{document.querySelectorAll('style[data-font-loader="true"]').forEach(t=>t.remove());const e=b.value.filter(t=>t.url);if(e.length>0){const t=document.createElement("style");t.setAttribute("data-font-loader","true");let l="";const n=[];e.forEach(d=>{l+=`
        @font-face {
          font-family: '${d.value}';
          src: url('${d.url}') format('${N(d.url)}');
          font-weight: normal;
          font-style: normal;
        }
      `;try{const i=new FontFace(d.value,`url(${d.url})`).load().then(r=>{document.fonts.add(r)}).catch(r=>{console.warn(`字体 ${d.value} 预加载失败:`,r)});n.push(i)}catch(o){console.warn(`字体 ${d.value} 初始化失败:`,o)}}),t.textContent=l,document.head.appendChild(t);try{await Promise.allSettled(n),_.value&&setTimeout(()=>{w()},200)}catch(d){console.warn("字体加载过程中出现错误:",d),_.value&&setTimeout(()=>{w()},200)}}else _.value&&h.value&&w()},N=e=>e.endsWith(".ttf")?"truetype":e.endsWith(".otf")?"opentype":e.endsWith(".woff")?"woff":e.endsWith(".woff2")?"woff2":"truetype",Le=e=>{if(k.value.file=e,e&&e.raw){M.value&&URL.revokeObjectURL(M.value);try{const t=URL.createObjectURL(e.raw);M.value=t;const l=`custom_preview_${Date.now()}`,n=document.createElement("style");n.setAttribute("data-font-preview","true"),n.textContent=`
        @font-face {
          font-family: '${l}';
          src: url('${t}') format('${N(e.raw.name)}');
          font-weight: normal;
          font-style: normal;
        }
        .font-preview-custom {
          font-family: '${l}', Arial, sans-serif;
        }
      `,document.head.appendChild(n)}catch(t){console.error("字体预览加载失败:",t),p.error("字体预览加载失败，但您仍可以上传字体")}}};Ke(()=>{if(c.templateTags&&c.templateTags.length>0){const e=new Map;c.templateTags.forEach(t=>{e.set(t.value,t)}),E.value=Array.from(e.values())}else P.get(`${S}/template-tags`).then(e=>{e.data.success&&e.data.tags&&e.data.tags.length>0?E.value=e.data.tags:E.value=[{label:"默认分类",value:"default"}]}).catch(e=>{console.error("获取模板分类失败:",e),E.value=[{label:"默认分类",value:"default"}]});ve().then(()=>{if(c.isEditMode&&c.templateData){a.name=c.templateData.name||"",a.tag=c.templateData.tag||"",a.imageSize=c.templateData.imageSize||"",a.serverImageUrl=c.templateData.previewImage||"",h.value=c.templateData.previewImage?re(c.templateData.previewImage):"";const e=c.templateData.text1;c.templateData.text1_enabled===!0||c.templateData.text1_enabled===1||e&&(e.enabled===!0||e.enabled===1)?(a.text1.enabled=!0,e&&(a.text1.font=e.font||q(),a.text1.x=typeof e.x=="number"?e.x:10,a.text1.y=typeof e.y=="number"?e.y:10,a.text1.width=typeof e.width=="number"?e.width:30,a.text1.height=typeof e.height=="number"?e.height:15,e.colorData&&e.colorData.type==="solid"?a.text1.color=e.colorData.value||"#FFFFFF":a.text1.color=e.color||"#FFFFFF",e.strokeColor&&e.strokeColor!=="rgba(0, 0, 0, 0)"?a.text1.strokeColor=e.strokeColor:a.text1.strokeColor=null)):a.text1.enabled=!1;const l=c.templateData.text2;c.templateData.text2_enabled===!0||c.templateData.text2_enabled===1||l&&(l.enabled===!0||l.enabled===1)?(a.text2.enabled=!0,l&&(a.text2.font=l.font||q(),a.text2.x=typeof l.x=="number"?l.x:10,a.text2.y=typeof l.y=="number"?l.y:60,a.text2.width=typeof l.width=="number"?l.width:30,a.text2.height=typeof l.height=="number"?l.height:15,l.colorData&&l.colorData.type==="solid"?a.text2.color=l.colorData.value||"#FFFFFF":a.text2.color=l.color||"#FFFFFF",l.strokeColor&&l.strokeColor!=="rgba(0, 0, 0, 0)"?a.text2.strokeColor=l.strokeColor:a.text2.strokeColor=null)):a.text2.enabled=!1,h.value&&setTimeout(()=>{w()},200)}}).catch(e=>{console.error("获取字体列表失败:",e),c.isEditMode&&c.templateData})}),Qe(()=>{document.removeEventListener("mousemove",Z),document.removeEventListener("mouseup",ee),b.value.forEach(e=>{e.url&&URL.revokeObjectURL(e.url)}),h.value&&h.value.startsWith("blob:")&&URL.revokeObjectURL(h.value),M.value&&(URL.revokeObjectURL(M.value),document.querySelectorAll('style[data-font-preview="true"]').forEach(e=>e.remove()))});const ge=(e="text1")=>{const t=a[e].font;if(!t)return;const l=b.value.find(o=>o.value===t);if(!l)return;let n=l.url;if(!n){w();return}w();const d=N(n);try{const o=document.createElement("style");o.setAttribute("data-font-loader-"+t,"true"),o.textContent=`
      @font-face {
        font-family: '${t}';
        src: local('Microsoft YaHei'), local('微软雅黑'),
             url('${n}') format('${d}');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }
    `,document.head.appendChild(o);const i=new FontFace(t,`url(${n})`,{display:"swap"});i.load().then(()=>{document.fonts.add(i),setTimeout(()=>w(),50)}).catch(r=>{console.warn(`字体加载问题: ${r.message}`),w()})}catch(o){console.error(`字体 ${t} 加载出错:`,o),w()}};return(e,t)=>{const l=Te,n=Ie,d=We,o=Ge,i=He,r=Xe,m=ze,g=Pe,W=Ne,V=qe,F=Ye,D=je,ae=Be,xe=Oe;return x(),U(T,null,[u(ae,{model:a,rules:Ce,ref_key:"templateFormRef",ref:se,"label-position":"top",class:"compact-form"},{default:f(()=>[u(D,{gutter:20},{default:f(()=>[u(F,{span:8},{default:f(()=>[v("div",tt,[u(n,{label:"模板名称",prop:"name",class:"rounded-form-item"},{default:f(()=>[u(l,{modelValue:a.name,"onUpdate:modelValue":t[0]||(t[0]=s=>a.name=s),placeholder:"请输入模板名称",class:"rounded-input"},null,8,["modelValue"])]),_:1}),u(n,{label:"上传水印图",prop:"image",class:"rounded-form-item"},{default:f(()=>[u(o,{class:"template-upload",action:"#","auto-upload":!1,limit:1,"on-change":Ee,"before-upload":Ve,"show-file-list":!1},{trigger:f(()=>[u(d,{type:"primary",class:"rounded-button"},{default:f(()=>t[21]||(t[21]=[$("选择图片")])),_:1,__:[21]})]),tip:f(()=>t[22]||(t[22]=[v("div",{class:"el-upload__tip"}," 仅支持png文件，且不超过5MB ",-1)])),_:1})]),_:1}),u(n,{label:"AI底图尺寸",prop:"imageSize",class:"rounded-form-item"},{default:f(()=>[u(m,{modelValue:a.imageSize,"onUpdate:modelValue":t[1]||(t[1]=s=>a.imageSize=s),placeholder:"请选择AI底图尺寸",class:"rounded-select w-100"},{default:f(()=>[(x(!0),U(T,null,z(K.filter(s=>s.orientation==="方形"),s=>(x(),H(i,{key:s.value,label:`${s.label} (${s.orientation})`,value:s.value},null,8,["label","value"]))),128)),u(r,{"content-position":"center"},{default:f(()=>t[23]||(t[23]=[$("横版")])),_:1,__:[23]}),(x(!0),U(T,null,z(K.filter(s=>s.orientation==="横版"),s=>(x(),H(i,{key:s.value,label:`${s.label} (${s.orientation})`,value:s.value},null,8,["label","value"]))),128)),u(r,{"content-position":"center"},{default:f(()=>t[24]||(t[24]=[$("竖版")])),_:1,__:[24]}),(x(!0),U(T,null,z(K.filter(s=>s.orientation==="竖版"),s=>(x(),H(i,{key:s.value,label:`${s.label} (${s.orientation})`,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(n,{label:"分类",prop:"tag",class:"rounded-form-item"},{default:f(()=>[u(m,{modelValue:a.tag,"onUpdate:modelValue":t[3]||(t[3]=s=>a.tag=s),placeholder:"请选择分类",class:"rounded-select w-100"},{default:f(()=>[(x(!0),U(T,null,z(E.value,s=>(x(),H(i,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128)),u(r),v("div",at,[u(d,{type:"primary",text:"",onClick:t[2]||(t[2]=s=>B.value=!0)},{default:f(()=>[u(g,null,{default:f(()=>[u(X(Ze))]),_:1}),t[25]||(t[25]=$("添加新分类 "))]),_:1,__:[25]})])]),_:1},8,["modelValue"])]),_:1})]),v("div",lt,[t[28]||(t[28]=v("h3",{class:"card-title"},"文字设置（可选）",-1)),u(D,{gutter:15},{default:f(()=>[u(F,{span:12},{default:f(()=>[v("div",ot,[v("div",nt,[t[26]||(t[26]=v("h4",null,"文字1",-1)),u(W,{modelValue:a.text1.enabled,"onUpdate:modelValue":t[4]||(t[4]=s=>a.text1.enabled=s)},null,8,["modelValue"])]),a.text1.enabled?(x(),U("div",st,[u(n,{label:"字体",class:"mb-2"},{default:f(()=>[v("div",rt,[u(m,{modelValue:a.text1.font,"onUpdate:modelValue":t[5]||(t[5]=s=>a.text1.font=s),placeholder:"请选择字体",class:"rounded-select font-select",onChange:t[6]||(t[6]=()=>ge("text1"))},{default:f(()=>[(x(!0),U(T,null,z(b.value,s=>(x(),H(i,{key:s.value,label:s.label,value:s.value},{default:f(()=>[v("div",it,[v("span",{style:we({fontFamily:ue(s.value)})},le(s.label),5)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"]),u(o,{class:"font-upload",action:"#","auto-upload":!1,"show-file-list":!1,"on-change":s=>me(s,"text1"),accept:".ttf,.otf,.woff,.woff2"},{default:f(()=>[u(d,{class:"upload-font-btn",type:"primary",circle:""},{default:f(()=>[u(g,null,{default:f(()=>[u(X(ye))]),_:1})]),_:1})]),_:1},8,["on-change"])])]),_:1}),u(D,{gutter:10},{default:f(()=>[u(F,{span:12},{default:f(()=>[u(n,{label:"文字颜色",class:"mb-2"},{default:f(()=>[v("div",ut,[u(V,{modelValue:a.text1.color,"onUpdate:modelValue":t[7]||(t[7]=s=>a.text1.color=s),"show-alpha":"",size:"large",class:"direct-color-picker",onChange:w},null,8,["modelValue"])])]),_:1})]),_:1}),u(F,{span:12},{default:f(()=>[u(n,{label:"描边",class:"mb-2"},{default:f(()=>[v("div",dt,[u(V,{modelValue:a.text1.strokeColor,"onUpdate:modelValue":t[8]||(t[8]=s=>a.text1.strokeColor=s),"show-alpha":"",size:"large",class:"direct-color-picker",onChange:w},null,8,["modelValue"])])]),_:1})]),_:1})]),_:1})])):G("",!0)])]),_:1}),u(F,{span:12},{default:f(()=>[v("div",ft,[v("div",ct,[t[27]||(t[27]=v("h4",null,"文字2",-1)),u(W,{modelValue:a.text2.enabled,"onUpdate:modelValue":t[9]||(t[9]=s=>a.text2.enabled=s)},null,8,["modelValue"])]),a.text2.enabled?(x(),U("div",mt,[u(n,{label:"字体",class:"mb-2"},{default:f(()=>[v("div",vt,[u(m,{modelValue:a.text2.font,"onUpdate:modelValue":t[10]||(t[10]=s=>a.text2.font=s),placeholder:"请选择字体",class:"rounded-select font-select",onChange:t[11]||(t[11]=()=>ge("text2"))},{default:f(()=>[(x(!0),U(T,null,z(b.value,s=>(x(),H(i,{key:s.value,label:s.label,value:s.value},{default:f(()=>[v("div",pt,[v("span",{style:we({fontFamily:ue(s.value)})},le(s.label),5)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"]),u(o,{class:"font-upload",action:"#","auto-upload":!1,"show-file-list":!1,"on-change":s=>me(s,"text2"),accept:".ttf,.otf,.woff,.woff2"},{default:f(()=>[u(d,{class:"upload-font-btn",type:"primary",circle:""},{default:f(()=>[u(g,null,{default:f(()=>[u(X(ye))]),_:1})]),_:1})]),_:1},8,["on-change"])])]),_:1}),u(D,{gutter:10},{default:f(()=>[u(F,{span:12},{default:f(()=>[u(n,{label:"文字颜色",class:"mb-2"},{default:f(()=>[v("div",ht,[u(V,{modelValue:a.text2.color,"onUpdate:modelValue":t[12]||(t[12]=s=>a.text2.color=s),"show-alpha":"",size:"large",class:"direct-color-picker",onChange:w},null,8,["modelValue"])])]),_:1})]),_:1}),u(F,{span:12},{default:f(()=>[u(n,{label:"描边",class:"mb-2"},{default:f(()=>[v("div",gt,[u(V,{modelValue:a.text2.strokeColor,"onUpdate:modelValue":t[13]||(t[13]=s=>a.text2.strokeColor=s),"show-alpha":"",size:"large",class:"direct-color-picker",onChange:w},null,8,["modelValue"])])]),_:1})]),_:1})]),_:1})])):G("",!0)])]),_:1})]),_:1})])]),_:1}),u(F,{span:16},{default:f(()=>[v("div",xt,[t[31]||(t[31]=v("h3",{class:"card-title"},"模板预览",-1)),v("div",bt,[h.value?(x(),U("canvas",{key:0,ref_key:"previewCanvas",ref:_,class:"preview-canvas",onMousedown:$e},null,544)):(x(),U("div",wt,[u(g,null,{default:f(()=>[u(X(et))]),_:1}),t[29]||(t[29]=v("p",null,"请上传图片预览",-1))]))]),h.value?(x(),U("div",yt,t[30]||(t[30]=[v("p",null,"预览效果仅供参考，实际效果可能会有所不同",-1)]))):G("",!0)])]),_:1})]),_:1})]),_:1},8,["model"]),u(xe,{modelValue:B.value,"onUpdate:modelValue":t[16]||(t[16]=s=>B.value=s),title:"添加分类",width:"400px","align-center":""},{footer:f(()=>[v("span",_t,[u(d,{onClick:t[15]||(t[15]=s=>B.value=!1)},{default:f(()=>t[32]||(t[32]=[$("取消")])),_:1,__:[32]}),u(d,{type:"primary",onClick:Se},{default:f(()=>t[33]||(t[33]=[$("确定")])),_:1,__:[33]})])]),default:f(()=>[u(ae,{model:I.value,"label-width":"100px"},{default:f(()=>[u(n,{label:"分类名称"},{default:f(()=>[u(l,{modelValue:I.value.name,"onUpdate:modelValue":t[14]||(t[14]=s=>I.value.name=s),placeholder:"请输入分类名称"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),u(xe,{modelValue:O.value,"onUpdate:modelValue":t[19]||(t[19]=s=>O.value=s),title:"上传字体",width:"400px"},{footer:f(()=>[v("span",Ct,[u(d,{onClick:t[18]||(t[18]=s=>O.value=!1)},{default:f(()=>t[37]||(t[37]=[$("取消")])),_:1,__:[37]}),u(d,{type:"primary",onClick:Re},{default:f(()=>t[38]||(t[38]=[$("确定")])),_:1,__:[38]})])]),default:f(()=>[u(ae,{model:k.value,"label-position":"top"},{default:f(()=>[u(n,{label:"自定义字体名称"},{default:f(()=>[u(l,{modelValue:k.value.name,"onUpdate:modelValue":t[17]||(t[17]=s=>k.value.name=s),placeholder:"请输入自定义字体名称"},null,8,["modelValue"])]),_:1}),u(n,{label:"字体文件"},{default:f(()=>[k.value.file?(x(),U("div",Ft,le(k.value.file.name),1)):G("",!0),u(o,{"auto-upload":!1,"show-file-list":!1,"on-change":s=>{Le(s)},accept:".ttf,.otf,.woff,.woff2",class:"font-upload-in-dialog"},{default:f(()=>[u(d,{type:"primary"},{default:f(()=>t[34]||(t[34]=[$("重新选择字体文件")])),_:1,__:[34]})]),_:1},8,["on-change"])]),_:1}),v("div",kt,[u(g,null,{default:f(()=>t[35]||(t[35]=[v("svg",{viewBox:"0 0 1024 1024",width:"1em",height:"1em",fill:"currentColor"},[v("path",{d:"M574 352h416c8.8 0 16 7.2 16 16v96c0 8.8-7.2 16-16 16H574c-8.8 0-16 7.2-16 16v96c0 8.8 7.2 16 16 16h416c8.8 0 16 7.2 16 16v96c0 8.8-7.2 16-16 16H574c-8.8 0-16-7.2-16-16v-96c0-8.8-7.2-16-16-16H126c-8.8 0-16-7.2-16-16v-96c0-8.8 7.2-16 16-16h416c8.8 0 16-7.2 16-16v-96c0-8.8-7.2-16-16-16H126c-8.8 0-16-7.2-16-16v-96c0-8.8 7.2-16 16-16h416c8.8 0 16 7.2 16 16v96c0 8.8 7.2 16 16 16z"})],-1)])),_:1,__:[35]}),t[36]||(t[36]=v("span",null,"拖动调整位置和大小",-1))])]),_:1},8,["model"])]),_:1},8,["modelValue"]),v("div",Ut,[u(d,{onClick:t[20]||(t[20]=s=>e.$emit("cancel")),class:"rounded-button cancel-btn"},{default:f(()=>t[39]||(t[39]=[$("取消")])),_:1,__:[39]}),u(d,{type:"primary",onClick:Me,class:"rounded-button submit-btn"},{default:f(()=>t[40]||(t[40]=[$("确定")])),_:1,__:[40]})])],64)}}},Tt=Ae($t,[["__scopeId","data-v-3cf78580"]]);export{Tt as T};
//# sourceMappingURL=TemplateForm-CJPZr2GT.js.map
